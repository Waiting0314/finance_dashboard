{% extends 'base.html' %}

{% block title %}{{ stock.ticker }} - è©³ç´°è³‡è¨Š{% endblock %}

{% block content %}
<!-- Breadcrumb Debug -->
<div class="breadcrumb">
    <a href="{% url 'dashboard' %}">å„€è¡¨æ¿</a> <span class="separator">/</span> <span class="current">
        {{ stock.ticker }}</span>
</div>

<div class="stock-detail-container">
    <!-- Top Section: Header & Price Card -->
    <div class="detail-header">
        <div class="stock-title">
            <h2>{{ stock.short_name|default:stock.name }} <span class="ticker-badge">{{ stock.ticker }}</span>
                {% if stock.alert_message %}
                <button onclick="openAlertModal()" class="alert-icon-btn" title="è²¡å‹™è­¦ç¤º">
                    <svg class="alert-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                </button>
                {% endif %}
            </h2>
            <div class="market-badge">
                {{ stock.get_market_display }}
                {% if is_trading %}
                <span class="trading-status trading-now">â— äº¤æ˜“ä¸­</span>
                {% else %}
                <span class="trading-status trading-closed">å·²æ”¶ç›¤</span>
                {% endif %}
            </div>
        </div>

        <div class="price-card">
            {% if latest_price %}
            <div class="current-price" style="color: {% if stock.change > 0 %}#e11d48{% elif stock.change < 0 %}#059669{% else %}#333{% endif %};">
                {{ latest_price.close }}
                <span style="font-size: 1rem; margin-left: 10px;">
                    {% if stock.change > 0 %}â–²{% elif stock.change < 0 %}â–¼{% endif %} {{ stock.change_percent|floatformat:2 }}%
                </span>
            </div>
            <div class="price-meta">
                <span class="date">è³‡æ–™æ—¥æœŸ: {{ latest_price.date }}</span>
                <span class="volume">æˆäº¤é‡: {{ latest_price.volume }}</span>
            </div>
            {% else %}
            <div class="no-data">å°šç„¡è‚¡åƒ¹è³‡æ–™</div>
            {% endif %}
        </div>
    </div>

    <!-- Main Section: Chart & Info -->
    <div class="main-grid">
        <!-- Left Column: Chart & Description -->
        <div class="chart-section">
            <div class="card-box chart-card">
                <h3>ä»Šæ—¥èµ°å‹¢ (Intraday)</h3>
                <div id="chart-intraday" style="width: 100%; height: 300px;"></div>
            </div>

            <div class="card-box chart-card" style="margin-top: 20px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <h3 style="margin:0;">æ­·å²èµ°å‹¢ (Historical)</h3>
                </div>
                <div id="chart-historical" style="width: 100%; height: 500px;"></div>
            </div>

            <!-- ä¸‰å¤§æ³•äººè²·è³£è¶…å€å¡Š - ç§»è‡³å…¬å¸ç°¡ä»‹ä¸Šæ–¹ -->
            <div class="card-box collapsible institutional-box" style="margin-top: 20px;">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>ä¸‰å¤§æ³•äººè²·è³£è¶…</h3>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div id="chart-institutional" style="width: 100%; height: 350px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœˆç‡Ÿæ”¶åœ–è¡¨ï¼ˆå°è‚¡å°ˆç”¨ï¼‰ -->
            <div class="card-box collapsible revenue-box" style="margin-top: 20px;" id="monthly-revenue-section">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>æœˆç‡Ÿæ”¶ <span class="data-source-badge" id="revenue-source-badge"></span></h3>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div id="chart-monthly-revenue" style="width: 100%; height: 320px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- PE/PB èµ°å‹¢åœ–è¡¨ -->
            <div class="card-box collapsible perpbr-box" style="margin-top: 20px;" id="perpbr-section">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>PE/PB èµ°å‹¢ <span class="data-source-badge" id="perpbr-source-badge"></span></h3>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div id="chart-per-pbr" style="width: 100%; height: 320px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- èè³‡èåˆ¸åœ–è¡¨ï¼ˆå°è‚¡å°ˆç”¨ï¼‰ -->
            <div class="card-box collapsible margin-box" style="margin-top: 20px;" id="margin-trading-section">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>èè³‡èåˆ¸ <span class="data-source-badge" id="margin-source-badge"></span></h3>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div id="chart-margin-trading" style="width: 100%; height: 320px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¾è‚¡é—œéµæŒ‡æ¨™æ‘˜è¦ï¼ˆç¾è‚¡å°ˆç”¨ï¼‰ -->
            <div class="card-box collapsible us-metrics-box" style="margin-top: 20px; display: none;" id="us-key-metrics-section">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>é—œéµè²¡å‹™æŒ‡æ¨™ <span class="data-source-badge" id="us-metrics-source-badge"></span></h3>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div id="us-key-metrics-grid" class="us-metrics-grid">
                        è¼‰å…¥ä¸­...
                    </div>
                    <div id="validation-warnings" class="validation-warnings" style="display: none;"></div>
                </div>
            </div>

            <div class="card-box collapsible info-box" style="margin-top: 20px;">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>å…¬å¸ç°¡ä»‹</h3>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div class="description" style="white-space: pre-wrap; line-height: 1.6; color: #444;">{{ stock.description|default:"æš«ç„¡ç°¡ä»‹" }}</div>
                </div>
            </div>

            <!-- è¿‘æœŸäº¤æ˜“æ´»å‹• - å¯æ”¶æ”¾ -->
            <div class="card-box collapsible recent-data-box" style="margin-top: 30px;">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>è¿‘æœŸäº¤æ˜“æ˜ç´°</h3>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <table class="recent-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>é–‹ç›¤</th>
                                <th>æœ€é«˜</th>
                                <th>æœ€ä½</th>
                                <th>æ”¶ç›¤</th>
                                <th>æˆäº¤é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in recent_prices %}
                            <tr>
                                <td>{{ price.date|date:"Y-m-d" }}</td>
                                <td>{{ price.open }}</td>
                                <td>{{ price.high }}</td>
                                <td>{{ price.low }}</td>
                                <td style="font-weight: bold; color: {% if price.close >= price.open %}#e11d48{% else %}#059669{% endif %};">{{ price.close }}</td>
                                <td>{{ price.volume }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999;">æš«ç„¡è¿‘æœŸæ•¸æ“š</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Indicators & News -->
        <div class="info-section">
            <!-- Financial Indicators (Expert Dashboard) -->
            <div class="card-box indicators-box">
                <h3>è²¡å‹™è¨ºæ–·æŒ‡æ¨™ (Expert View)</h3>
                
                <!-- 1. ç²åˆ©èƒ½åŠ› Profitability -->
                <h4 style="margin: 15px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">ç²åˆ©èƒ½åŠ› (Profitability)</h4>
                <div class="metrics-grid">
                    <div class="metric-item tooltip-container">
                        <label>ROE (è‚¡æ±æ¬Šç›Šå ±é…¬ç‡)</label>
                        <div class="value">
                            {% load stock_filters %}
                            {{ stock.roe|percentage }}
                        </div>
                        <span class="tooltip-text">å·´è²ç‰¹æœ€çœ‹é‡çš„æŒ‡æ¨™ã€‚è¡¡é‡å…¬å¸é‹ç”¨è‚¡æ±è³‡é‡‘å‰µé€ ç²åˆ©çš„æ•ˆç‡ï¼Œé•·æœŸ >15% ç‚ºä½³ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>ROA (è³‡ç”¢å ±é…¬ç‡)</label>
                        <div class="value">{{ stock.roa|percentage }}</div>
                        <span class="tooltip-text">å…¬å¸åˆ©ç”¨ç¸½è³‡ç”¢è³ºéŒ¢çš„èƒ½åŠ›ã€‚ROA èˆ‡ ROE å·®è·éå¤§å¯èƒ½ä»£è¡¨é«˜æ§“æ¡¿ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>æ¯›åˆ©ç‡ (Gross Margin)</label>
                        <div class="value">{{ stock.gross_margin|percentage }}</div>
                        <span class="tooltip-text">ç”¢å“ç«¶çˆ­åŠ›çš„è­·åŸæ²³ã€‚è¶Šé«˜ä»£è¡¨ç”¢å“è¶Šæœ‰å®šåƒ¹æ¬Šã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>ç‡Ÿæ¥­åˆ©ç›Šç‡ (Op. Margin)</label>
                        <div class="value">{{ stock.operating_margin|percentage }}</div>
                        <span class="tooltip-text">æœ¬æ¥­è³ºéŒ¢çš„èƒ½åŠ›ã€‚æ‰£é™¤æˆæœ¬èˆ‡ç‡Ÿæ¥­è²»ç”¨å¾Œçš„ç²åˆ©æ¯”ç‡ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>æ·¨åˆ©ç‡ (Net Margin)</label>
                        <div class="value">{{ stock.profit_margin|percentage }}</div>
                        <span class="tooltip-text">æœ€çµ‚è½å…¥å£è¢‹çš„éŒ¢ã€‚</span>
                    </div>
                </div>

                <!-- 2. å„Ÿå‚µèˆ‡çµæ§‹ Solvency & Structure -->
                <h4 style="margin: 25px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">å„Ÿå‚µèƒ½åŠ›èˆ‡çµæ§‹ (Solvency)</h4>
                <div class="metrics-grid">
                    <div class="metric-item tooltip-container">
                        <label>è² å‚µæ¬Šç›Šæ¯” (Debt/Equity)</label>
                        <div class="value">{{ stock.debt_to_equity|default:"-" }}%</div>
                        <span class="tooltip-text">è¡¡é‡è²¡å‹™æ§“æ¡¿ã€‚æ•¸å€¼éé«˜ (å¦‚ >200) ä»£è¡¨å‚µå‹™å£“åŠ›å¤§ï¼Œé¢¨éšªè¼ƒé«˜ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>é€Ÿå‹•æ¯”ç‡ (Quick Ratio)</label>
                        <div class="value">{{ stock.quick_ratio|default:"-" }}</div>
                        <span class="tooltip-text">è¡¡é‡çŸ­æœŸå„Ÿå‚µèƒ½åŠ›ã€‚æ‰£é™¤å­˜è²¨å¾Œçš„æµå‹•è³‡ç”¢/æµå‹•è² å‚µï¼Œ>1 ç‚ºå®‰å…¨ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>è²å¡”å€¼ (Beta)</label>
                        <div class="value">{{ stock.beta|default:"-" }}</div>
                        <span class="tooltip-text">æ³¢å‹•é¢¨éšªä¿‚æ•¸ã€‚>1 ä»£è¡¨æ³¢å‹•æ¯”å¤§ç›¤å¤§ (æ”»æ“Šå‹)ï¼Œ<1 ä»£è¡¨æ³¢å‹•å° (é˜²ç¦¦å‹)ã€‚</span>
                    </div>
                </div>

                <!-- 3. ä¼°å€¼èˆ‡æˆé•· Valuation -->
                <h4 style="margin: 25px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">ä¼°å€¼èˆ‡æˆé•· (Valuation)</h4>
                <div class="metrics-grid">
                    <div class="metric-item tooltip-container">
                        <label>æœ¬ç›Šæ¯” (P/E)</label>
                        <div class="value">{{ stock.pe_ratio|default:"-" }}</div>
                        <span class="tooltip-text">å›æœ¬å¹´é™æ¦‚å¿µã€‚æˆé•·è‚¡é€šå¸¸äº«æœ‰é«˜æœ¬ç›Šæ¯”ï¼Œåƒ¹å€¼è‚¡å‰‡è¼ƒä½ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>è‚¡åƒ¹æ·¨å€¼æ¯” (P/B)</label>
                        <div class="value">{{ stock.price_to_book|default:"-" }}</div>
                        <span class="tooltip-text">è‚¡åƒ¹/æ¯è‚¡æ·¨å€¼ã€‚é€šå¸¸ <1 ä»£è¡¨è‚¡åƒ¹ä½æ–¼æ¸…ç®—åƒ¹å€¼ï¼Œå¯èƒ½è¢«ä½ä¼°ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>æ®–åˆ©ç‡ (Yield)</label>
                        <div class="value">{{ stock.dividend_yield|default:"-" }}</div>
                        <span class="tooltip-text">ç¾é‡‘è‚¡åˆ©å›å ±ç‡ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>å¸‚å€¼ (Market Cap)</label>
                        <div class="value">{{ stock.market_cap|filesizeformat }}</div>
                        <span class="tooltip-text">å…¬å¸ç¸½åƒ¹å€¼ã€‚</span>
                    </div>
                </div>

                <!-- 4. ç¾é‡‘æµ Cash Flow -->
                <h4 style="margin: 25px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">ç¾é‡‘æµèˆ‡è²¡å ± (Cash Flow)</h4>
                <div class="metrics-grid">
                    <div class="metric-item tooltip-container">
                        <label>è‡ªç”±ç¾é‡‘æµ (FCF)</label>
                        <div class="value" style="font-size: 0.9rem;">
                            {% if stock.free_cash_flow %}
                                {% load stock_filters %}{{ stock.free_cash_flow|format_revenue }}
                            {% else %}-{% endif %}
                        </div>
                        <span class="tooltip-text">å…¬å¸çœŸæ­£å¯ä»¥è‡ªç”±é‹ç”¨çš„ç¾é‡‘ã€‚æ­£å€¼ä»£è¡¨å…¬å¸æœ‰èƒ½åŠ›ç™¼è‚¡åˆ©æˆ–å†æŠ•è³‡ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>ç‡Ÿæ”¶ (Revenue)</label>
                        <div class="value" style="font-size: 0.9rem;">
                            {% if stock.last_revenue %}
                            <a href="https://finance.yahoo.com/quote/{{ stock.ticker }}/financials" target="_blank" style="color: #2563eb; text-decoration: underline;">
                                {{ stock.last_revenue|format_revenue }}
                            </a>
                            {% else %}-{% endif %}
                        </div>
                        <span class="tooltip-text">æœ€è¿‘ä¸€æœŸç¸½ç‡Ÿæ”¶ (é€£çµè‡³ Yahoo Finance)ã€‚</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>ä¸‹æ¬¡è²¡å ±æ—¥</label>
                        <div class="value">
                            {% if stock.next_earnings_date %}
                                {{ stock.next_earnings_date|date:"Y-m-d" }}
                                {% now "Y-m-d" as today %}
                                {% if stock.next_earnings_date|date:"Y-m-d" < today %}
                                    <span style="background: #fecaca; color: #dc2626; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">å·²éæœŸ</span>
                                {% endif %}
                            {% else %}-{% endif %}
                        </div>
                        <span class="tooltip-text">é è¨ˆå…¬å¸ƒè²¡å ±æ—¥æœŸã€‚</span>
                    </div>
                </div>

                <!-- 5. æŠ€è¡“æŒ‡æ¨™èªªæ˜ Technical Indicators -->
                <h4 style="margin: 25px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">æŠ€è¡“æŒ‡æ¨™èªªæ˜ (Technical Indicators)</h4>
                <div style="background: #f8fafc; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong style="color: #1e3a5f; font-size: 0.95rem;">RSI ç›¸å°å¼·å¼±æŒ‡æ¨™</strong>
                        <div id="current-rsi-display" style="font-size: 1.2rem; font-weight: 700; padding: 6px 12px; border-radius: 6px; background: #e2e8f0; color: #64748b;">
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                    <p style="color: #64748b; font-size: 0.85rem; margin: 0 0 12px 0; line-height: 1.5;">
                        ç”¨ä¾†è©•ä¼°è‚¡åƒ¹æ˜¯å¦è¶…è²·æˆ–è¶…è³£çš„å‹•èƒ½æŒ‡æ¨™ã€‚
                    </p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <div id="rsi-overbought-card" style="flex: 1; min-width: 120px; background: #fef3c7; padding: 10px; border-radius: 6px; border-left: 3px solid #f59e0b; opacity: 0.5;">
                            <strong style="color: #92400e; font-size: 0.8rem;">RSI > 70</strong>
                            <p style="color: #78350f; font-size: 0.75rem; margin: 3px 0 0 0;">è¶…è²·å€ï¼šè‚¡åƒ¹å¯èƒ½éç†±ï¼Œæœ‰æ‹‰å›é¢¨éšª</p>
                        </div>
                        <div id="rsi-oversold-card" style="flex: 1; min-width: 120px; background: #dbeafe; padding: 10px; border-radius: 6px; border-left: 3px solid #3b82f6; opacity: 0.5;">
                            <strong style="color: #1e40af; font-size: 0.8rem;">RSI < 30</strong>
                            <p style="color: #1e3a8a; font-size: 0.75rem; margin: 3px 0 0 0;">è¶…è³£å€ï¼šè‚¡åƒ¹å¯èƒ½éä½ï¼Œæœ‰åå½ˆæ©Ÿæœƒ</p>
                        </div>
                    </div>
                    <p style="color: #94a3b8; font-size: 0.75rem; margin-top: 10px; text-align: right;">åƒæ•¸è¨­å®šï¼šRSI(14)</p>
                </div>
            </div>

            <!-- News Section - æ”¯æ´åˆ†é èˆ‡æƒ…ç·’åˆ†æ -->
            <div class="card-box collapsible news-box" style="margin-top: 30px;">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>ç›¸é—œæ–°è <span id="news-count" class="news-count-badge"></span></h3>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div id="news-wrapper">
                        <div style="display: flex; align-items: center; justify-content: center; padding: 40px; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            è¼‰å…¥æ–°èä¸­...
                        </div>
                    </div>
                    <!-- åˆ†é æ§åˆ¶é … -->
                    <div id="news-pagination" class="news-pagination" style="display: none;">
                        <button onclick="prevNewsPage()" id="news-prev-btn" class="pagination-btn" disabled>
                            â† ä¸Šä¸€é 
                        </button>
                        <span id="news-page-indicator" class="page-indicator">1/1</span>
                        <button onclick="nextNewsPage()" id="news-next-btn" class="pagination-btn">
                            ä¸‹ä¸€é  â†’
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div style="margin-top: 20px;">
        <a href="{% url 'dashboard' %}" class="back-link">&larr; è¿”å›å„€è¡¨æ¿</a>
    </div>
</div>

<!-- è²¡å‹™è­¦ç¤º Modal -->
{% if stock.alert_message %}
<div id="alertModal" class="alert-modal-backdrop" style="display: none;">
    <div class="alert-modal">
        <div class="alert-modal-header">
            <div class="alert-modal-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
            </div>
            <h3>è²¡å‹™è­¦ç¤ºåˆ†æ</h3>
            <button onclick="closeAlertModal()" class="alert-modal-close">&times;</button>
        </div>
        <div class="alert-modal-body">
            <p class="alert-modal-subtitle">{{ stock.ticker }} æœ‰ä»¥ä¸‹éœ€è¦é—œæ³¨çš„è²¡å‹™æŒ‡æ¨™ï¼š</p>
            <div class="alert-items">
                {% for line in stock.alert_message.splitlines %}
                <div class="alert-item">
                    {{ line }}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="alert-modal-footer">
            <p class="alert-disclaimer">ä»¥ä¸Šåˆ†æåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚è«‹è‡ªè¡Œè©•ä¼°é¢¨éšªã€‚</p>
            <button onclick="closeAlertModal()" class="alert-modal-btn">äº†è§£</button>
        </div>
    </div>
</div>
{% endif %}

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ticker = "{{ stock.ticker }}";
        const api_url = "{% url 'stock_detail_api' stock.ticker %}";

        // DOM Elements
        const chartIntradayDom = document.getElementById('chart-intraday');
        const chartHistoricalDom = document.getElementById('chart-historical');
        const newsContainer = document.getElementById('news-wrapper'); // Updated selector
        const descContainer = document.querySelector('.description');

        // Show Loading State
        if (chartHistoricalDom) {
            const loadingChart = echarts.init(chartHistoricalDom);
            loadingChart.showLoading({ text: 'æ•¸æ“šè¼‰å…¥ä¸­...', color: '#00bfa5', textColor: '#00bfa5' });
        }

        fetch(api_url)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // 1. Update Description
                if (descContainer) {
                    // Check if data is valid and not the generic API placeholder
                    if (data.description && data.description !== 'æš‚æ— ç®€ä»‹' && data.description.trim() !== '') {
                        descContainer.innerText = data.description;
                    } else {
                        descContainer.innerText = "æš«ç„¡ç°¡ä»‹";
                    }
                }

                // 2. Update News - æ”¯æ´åˆ†é èˆ‡æƒ…ç·’ icon
                if (newsContainer) {
                    if (data.news && data.news.length > 0) {
                        // å„²å­˜æ‰€æœ‰æ–°èç”¨æ–¼åˆ†é 
                        window.allNewsItems = data.news;
                        window.newsCurrentPage = 1;
                        window.newsPerPage = 10;
                        
                        // æ›´æ–°æ–°èæ•¸é‡ badge
                        const countBadge = document.getElementById('news-count');
                        if (countBadge) countBadge.textContent = data.news.length + ' å‰‡';
                        
                        // é¡¯ç¤ºåˆ†é æ§åˆ¶é …
                        const pagination = document.getElementById('news-pagination');
                        if (pagination && data.news.length > window.newsPerPage) {
                            pagination.style.display = 'flex';
                        }
                        
                        // æ¸²æŸ“ç¬¬ä¸€é 
                        renderNewsPage(1);
                    } else {
                        newsContainer.innerHTML = '<p class="no-news">æš«ç„¡ç›¸é—œæ–°è</p>';
                    }
                }

                // 3. Render Intraday Chart
                // Dispose previous instance if any (though unlikely on fresh load)
                echarts.dispose(chartIntradayDom);
                if (data.intraday_data && data.intraday_data.length > 0) {
                    const myChart = echarts.init(chartIntradayDom);
                    const dates = data.intraday_data.map(item => item[0]);
                    const prices = data.intraday_data.map(item => item[1]);

                    const option = {
                        tooltip: { trigger: 'axis' },
                        grid: { left: '3%', right: '3%', top: '10%', bottom: '10%', containLabel: true },
                        xAxis: { type: 'category', data: dates, boundaryGap: false },
                        yAxis: { scale: true },
                        series: [{
                            name: 'åƒ¹æ ¼',
                            type: 'line',
                            data: prices,
                            smooth: true,
                            showSymbol: false,
                            lineStyle: { color: '#0066cc', width: 2 },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 102, 204, 0.3)' },
                                    { offset: 1, color: 'rgba(0, 102, 204, 0.05)' }
                                ])
                            }
                        }]
                    };
                    myChart.setOption(option);
                    window.addEventListener('resize', () => myChart.resize());
                } else {
                    chartIntradayDom.innerHTML = '<p class="no-data-text" style="text-align:center; padding-top:100px; color:#999;">æš«ç„¡ä»Šæ—¥èµ°å‹¢è³‡æ–™</p>';
                }

                // 4. Render Historical Chart
                echarts.dispose(chartHistoricalDom);
                if (data.historical_data && data.historical_data.length > 0) {
                    const myChart = echarts.init(chartHistoricalDom);
                    const rawData = data.historical_data;
                    const dates = rawData.map(item => item[0]);
                    const ohlc = rawData.map(item => [item[1], item[2], item[3], item[4]]); // Open, Close, Low, High
                    const closes = rawData.map(item => item[2]);

                    // Calculations
                    function calculateMA(dayCount, data) {
                        var result = [];
                        for (var i = 0, len = data.length; i < len; i++) {
                            if (i < dayCount) {
                                result.push('-');
                                continue;
                            }
                            var sum = 0;
                            for (var j = 0; j < dayCount; j++) {
                                sum += data[i - j][2]; // Close
                            }
                            result.push((sum / dayCount).toFixed(2));
                        }
                        return result;
                    }

                    function calculateRSI(data, period = 14) {
                        let rsi = [];
                        for (let i = 0; i < data.length; i++) {
                            if (i < period) {
                                rsi.push('-');
                                continue;
                            }
                            let gain = 0, loss = 0;
                            for (let j = 0; j < period; j++) {
                                let change = data[i - j] - data[i - j - 1];
                                if (change > 0) gain += change;
                                if (change < 0) loss += Math.abs(change);
                            }
                            let rs = loss === 0 ? 100 : gain / loss;
                            let val = 100 - (100 / (1 + rs));
                            rsi.push(val.toFixed(2));
                        }
                        return rsi;
                    }

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' },
                            formatter: function (params) {
                                let res = params[0].name + '<br/>';
                                params.forEach(function (item) {
                                    // Custom formatting to clarify Price vs RSI
                                    let color = item.color;
                                    if (typeof color === 'object' && color.colorStops) color = color.colorStops[0].color; // Gradient handling

                                    if (item.seriesName === 'Kç·š') {
                                        res += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${color};"></span>` +
                                            `é–‹: ${parseFloat(item.data[1]).toFixed(2)} æ”¶: ${parseFloat(item.data[2]).toFixed(2)} <br/>` +
                                            `&nbsp;&nbsp;&nbsp;&nbsp;ä½: ${parseFloat(item.data[3]).toFixed(2)} é«˜: ${parseFloat(item.data[4]).toFixed(2)}<br/>`;
                                    } else {
                                        let val = parseFloat(item.value);
                                        let displayVal = (item.seriesName === 'æˆäº¤é‡') ? val.toFixed(0) : val.toFixed(2);
                                        res += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>` +
                                            `${item.seriesName}: ${displayVal}<br/>`;
                                    }
                                });
                                return res;
                            }
                        },
                        legend: { data: ['Kç·š', 'MA5', 'MA20', 'æˆäº¤é‡', 'RSI(14)'], top: 0 },
                        axisPointer: { link: { xAxisIndex: 'all' } },
                        grid: [
                            { left: '5%', right: '3%', top: '8%', height: '40%' },   // K-line
                            { left: '5%', right: '3%', top: '52%', height: '10%' },  // Volume
                            { left: '5%', right: '3%', top: '66%', height: '14%' }   // RSI
                        ],
                        xAxis: [
                            { type: 'category', data: dates, gridIndex: 0, axisLine: { onZero: false }, axisLabel: { show: false } },
                            { type: 'category', data: dates, gridIndex: 1, axisLabel: { show: false }, axisTick: { show: false } },
                            { type: 'category', data: dates, gridIndex: 2, axisLabel: { show: true, fontSize: 10, rotate: 45 }, axisTick: { show: true } }
                        ],
                        yAxis: [
                            { scale: true, gridIndex: 0, splitLine: { show: true } },
                            { scale: true, gridIndex: 1, splitLine: { show: false }, axisLabel: { show: false } },
                            { scale: true, gridIndex: 2, splitLine: { show: false }, min: 0, max: 100 }
                        ],
                        dataZoom: [
                            { type: 'inside', xAxisIndex: [0, 1, 2], start: 50, end: 100 },
                            { type: 'slider', xAxisIndex: [0, 1, 2], bottom: 0, start: 50, end: 100 }
                        ],
                        series: [
                            {
                                name: 'Kç·š',
                                type: 'candlestick',
                                data: ohlc,
                                // Taiwan: Red=Up, Green=Down
                                itemStyle: { color: '#e11d48', color0: '#059669', borderColor: '#e11d48', borderColor0: '#059669' }
                            },
                            { name: 'MA5', type: 'line', data: calculateMA(5, rawData), smooth: true, lineStyle: { opacity: 0.5 } },
                            { name: 'MA20', type: 'line', data: calculateMA(20, rawData), smooth: true, lineStyle: { opacity: 0.5 } },
                            {
                                name: 'æˆäº¤é‡',
                                type: 'bar',
                                xAxisIndex: 1,
                                yAxisIndex: 1,
                                data: rawData.map((d, i) => ({
                                    value: d[5],  // Volume is at index 5: [date, O, C, L, H, Volume]
                                    itemStyle: { color: closes[i] >= (i > 0 ? closes[i-1] : closes[i]) ? '#e11d48' : '#059669' }
                                }))
                            },
                            {
                                name: 'RSI(14)',
                                type: 'line',
                                xAxisIndex: 2,
                                yAxisIndex: 2,
                                data: calculateRSI(closes, 14),
                                lineStyle: { color: '#8e44ad', width: 1.5 },
                                markLine: { symbol: 'none', data: [{ yAxis: 70, lineStyle: { color: '#f59e0b' } }, { yAxis: 30, lineStyle: { color: '#3b82f6' } }] }
                            }
                        ]
                    };
                    myChart.setOption(option);
                    window.addEventListener('resize', () => myChart.resize());
                    
                    // Update RSI Display in Sidebar
                    const rsiData = calculateRSI(closes, 14);
                    const latestRsi = rsiData.filter(v => v !== '-').pop();
                    const rsiDisplay = document.getElementById('current-rsi-display');
                    const overboughtCard = document.getElementById('rsi-overbought-card');
                    const oversoldCard = document.getElementById('rsi-oversold-card');
                    
                    if (latestRsi && rsiDisplay) {
                        const rsiValue = parseFloat(latestRsi);
                        rsiDisplay.textContent = rsiValue.toFixed(2);
                        
                        if (rsiValue > 70) {
                            // Overbought - Yellow/Orange
                            rsiDisplay.style.background = '#fef3c7';
                            rsiDisplay.style.color = '#92400e';
                            if (overboughtCard) overboughtCard.style.opacity = '1';
                        } else if (rsiValue < 30) {
                            // Oversold - Blue
                            rsiDisplay.style.background = '#dbeafe';
                            rsiDisplay.style.color = '#1e40af';
                            if (oversoldCard) oversoldCard.style.opacity = '1';
                        } else {
                            // Neutral - Green
                            rsiDisplay.style.background = '#d1fae5';
                            rsiDisplay.style.color = '#065f46';
                        }
                    } else if (rsiDisplay) {
                        rsiDisplay.textContent = 'N/A';
                    }
                } else {
                    chartHistoricalDom.innerHTML = '<p class="no-data-text" style="text-align:center; padding-top:150px; color:#999;">æš«ç„¡æ­·å²èµ°å‹¢è³‡æ–™</p>';
                }

                // 5. ä¸‰å¤§æ³•äººè²·è³£è¶…åœ–è¡¨
                const institutionalDom = document.getElementById('chart-institutional');
                if (institutionalDom) {
                    // å®¹éŒ¯è™•ç†ï¼šæª¢æŸ¥è³‡æ–™æ˜¯å¦å­˜åœ¨
                    if (data.institutional_investors === null) {
                        // ç¾è‚¡æˆ–ä¸æ”¯æ´çš„å¸‚å ´
                        institutionalDom.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; 
                                        height: 100%; color: #94a3b8; flex-direction: column; gap: 12px;">
                                <svg style="width: 48px; height: 48px; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span style="font-size: 0.95rem;">æ­¤åŠŸèƒ½åƒ…æ”¯æ´å°è‚¡</span>
                            </div>`;
                    } else if (!data.institutional_investors || data.institutional_investors.length === 0) {
                        // å°è‚¡ä½†ç„¡è³‡æ–™
                        institutionalDom.innerHTML = `
                            <p style="text-align: center; padding-top: 120px; color: #999;">
                                æš«ç„¡ä¸‰å¤§æ³•äººè²·è³£è¶…è³‡æ–™
                            </p>`;
                    } else {
                        // æ­£å¸¸æ¸²æŸ“åœ–è¡¨
                        const instData = data.institutional_investors;
                        const dates = instData.map(d => d.date);
                        
                        // å°‡è‚¡æ•¸è½‰æ›ç‚ºå¼µæ•¸ï¼ˆé™¤ä»¥ 1000ï¼‰
                        const foreignNet = instData.map(d => Math.round(d.foreign_net / 1000));
                        const trustNet = instData.map(d => Math.round(d.trust_net / 1000));
                        const dealerNet = instData.map(d => Math.round(d.dealer_net / 1000));
                        
                        const instChart = echarts.init(institutionalDom);
                        const instOption = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' },
                                formatter: function(params) {
                                    let res = params[0].name + '<br/>';
                                    params.forEach(p => {
                                        const val = p.value;
                                        const color = val >= 0 ? '#e11d48' : '#059669';
                                        const sign = val >= 0 ? '+' : '';
                                        res += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${p.color};"></span>` +
                                               `${p.seriesName}: <span style="color:${color};font-weight:bold;">${sign}${val.toLocaleString()}</span> å¼µ<br/>`;
                                    });
                                    return res;
                                }
                            },
                            legend: {
                                data: ['å¤–è³‡', 'æŠ•ä¿¡', 'è‡ªç‡Ÿå•†'],
                                top: 0
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '15%',
                                top: '15%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'category',
                                data: dates,
                                axisLabel: { 
                                    rotate: 45, 
                                    fontSize: 10,
                                    interval: Math.floor(dates.length / 10) // åªé¡¯ç¤ºéƒ¨åˆ†æ—¥æœŸ
                                }
                            },
                            yAxis: {
                                type: 'value',
                                name: 'å¼µæ•¸',
                                axisLabel: {
                                    formatter: function(val) {
                                        if (Math.abs(val) >= 10000) {
                                            return (val / 10000).toFixed(1) + 'è¬';
                                        }
                                        return val;
                                    }
                                }
                            },
                            dataZoom: [
                                { type: 'inside', start: 50, end: 100 },
                                { type: 'slider', bottom: 0, start: 50, end: 100, height: 20 }
                            ],
                            series: [
                                {
                                    name: 'å¤–è³‡',
                                    type: 'bar',
                                    data: foreignNet,
                                    itemStyle: {
                                        color: function(params) {
                                            return params.value >= 0 ? '#ef4444' : '#22c55e';
                                        }
                                    }
                                },
                                {
                                    name: 'æŠ•ä¿¡',
                                    type: 'bar',
                                    data: trustNet,
                                    itemStyle: {
                                        color: function(params) {
                                            return params.value >= 0 ? '#f97316' : '#14b8a6';
                                        }
                                    }
                                },
                                {
                                    name: 'è‡ªç‡Ÿå•†',
                                    type: 'bar',
                                    data: dealerNet,
                                    itemStyle: {
                                        color: function(params) {
                                            return params.value >= 0 ? '#a855f7' : '#06b6d4';
                                        }
                                    }
                                }
                            ]
                        };
                        instChart.setOption(instOption);
                        window.addEventListener('resize', () => instChart.resize());
                    }
                }

            })
            .catch(err => {
                console.error('Fetch Error:', err);
                if (chartHistoricalDom) chartHistoricalDom.innerHTML = '<p style="text-align:center; padding-top:150px; color:red;">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
            });

    }); // DOMContentLoaded çµæŸ

    // === æ–°èåˆ†é ç›¸é—œå‡½æ•¸ ===
    function renderNewsPage(page) {
        const newsContainer = document.getElementById('news-wrapper');
        if (!window.allNewsItems || !newsContainer) return;
        
        const start = (page - 1) * window.newsPerPage;
        const end = start + window.newsPerPage;
        const pageItems = window.allNewsItems.slice(start, end);
        
        const totalPages = Math.ceil(window.allNewsItems.length / window.newsPerPage);
        window.newsCurrentPage = page;
        
        // æ¸²æŸ“æ–°èé …ç›®å«æƒ…ç·’ icon
        const newsItemsHtml = pageItems.map(item => {
            let sentimentHtml = '';
            if (item.sentiment === 'positive') {
                sentimentHtml = '<span class="sentiment-icon sentiment-positive">ğŸ˜Š</span>';
            } else if (item.sentiment === 'negative') {
                sentimentHtml = '<span class="sentiment-icon sentiment-negative">ğŸ˜Ÿ</span>';
            } else {
                sentimentHtml = '<span class="sentiment-icon sentiment-neutral">â€¢</span>';
            }
            
            return `
                <li class="news-item">
                    <a href="${item.link}" target="_blank" class="news-title">
                        ${sentimentHtml}${item.title}
                    </a>
                    <div class="news-meta">
                        <span>${item.publisher || 'Unknown'}</span>
                        <span>${item.date || ''}</span>
                    </div>
                </li>
            `;
        }).join('');
        
        newsContainer.innerHTML = `<ul class="news-list">${newsItemsHtml}</ul>`;
        
        // æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
        const prevBtn = document.getElementById('news-prev-btn');
        const nextBtn = document.getElementById('news-next-btn');
        const indicator = document.getElementById('news-page-indicator');
        
        if (prevBtn) prevBtn.disabled = page <= 1;
        if (nextBtn) nextBtn.disabled = page >= totalPages;
        if (indicator) indicator.textContent = `${page}/${totalPages}`;
    }
    
    function prevNewsPage() {
        if (window.newsCurrentPage > 1) {
            renderNewsPage(window.newsCurrentPage - 1);
        }
    }
    
    function nextNewsPage() {
        const totalPages = Math.ceil(window.allNewsItems.length / window.newsPerPage);
        if (window.newsCurrentPage < totalPages) {
            renderNewsPage(window.newsCurrentPage + 1);
        }
    }

    // === å¡ç‰‡æ”¶æ”¾å‡½æ•¸ ===
    function toggleCard(headerElement) {
        const card = headerElement.closest('.collapsible');
        if (card) {
            card.classList.toggle('collapsed');
            // å„²å­˜ç‹€æ…‹åˆ° localStorage
            const cardId = card.id || card.className;
            const isCollapsed = card.classList.contains('collapsed');
            localStorage.setItem('card-' + cardId.replace(/\s+/g, '-'), isCollapsed);
        }
    }
    
    // è¼‰å…¥å¡ç‰‡æ”¶æ”¾ç‹€æ…‹
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.collapsible').forEach(card => {
            const cardId = card.id || card.className;
            const savedState = localStorage.getItem('card-' + cardId.replace(/\s+/g, '-'));
            if (savedState === 'true') {
                card.classList.add('collapsed');
            }
        });
    });

    // === è²¡å‹™è­¦ç¤º Modal å‡½æ•¸ ===
    function openAlertModal() {
        const modal = document.getElementById('alertModal');
        if (modal) modal.style.display = 'flex';
    }
    
    function closeAlertModal() {
        const modal = document.getElementById('alertModal');
        if (modal) modal.style.display = 'none';
    }
    
    // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('alert-modal-backdrop')) {
            closeAlertModal();
        }
    });
    
    // ESC éµé—œé–‰ Modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeAlertModal();
    });

    // Real-time Price Update (Separate Endpoint)
    function updatePrice() {
        const currentPriceEl = document.querySelector('.current-price');
        // åŠ å…¥ä¸€å€‹ç°¡å–®çš„é–ƒçˆæ•ˆæœ
        if (currentPriceEl) {
             currentPriceEl.style.transition = 'color 0.5s';
        }

        fetch('{% url "get_latest_price" stock.ticker %}')
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                if (currentPriceEl) {
                    const oldPrice = parseFloat(currentPriceEl.textContent);
                    const newPrice = parseFloat(data.price);
                    
                    if (newPrice !== oldPrice) {
                        currentPriceEl.textContent = newPrice.toFixed(2);
                        // Flash color based on change
                        if (newPrice > oldPrice) {
                            currentPriceEl.style.color = '#e11d48'; // Red
                        } else if (newPrice < oldPrice) {
                            currentPriceEl.style.color = '#059669'; // Green
                        }
                    }
                }
            })
            .catch(e => console.log('Price update error:', e));
    }

    {% if is_trading %}
    setInterval(updatePrice, 10000);
    {% endif %}
</script>

<style>
    /* Breadcrumb */
    .breadcrumb {
        margin-bottom: 25px;
        font-size: 0.95em;
        color: #666;
        background: white;
        padding: 10px 15px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
    }

    .breadcrumb a {
        color: var(--secondary-color);
        font-weight: 500;
    }

    .stock-detail-container {
        padding: 30px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 25px;
        margin-bottom: 30px;
    }

    .stock-title h2 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 2em;
        color: var(--primary-color);
    }

    .ticker-badge {
        font-size: 0.5em;
        background: #e9ecef;
        padding: 4px 10px;
        border-radius: 20px;
        color: #495057;
        vertical-align: middle;
    }

    .market-badge {
        margin-top: 8px;
        color: #6c757d;
        font-weight: 600;
        font-size: 1.1em;
    }

    .price-card {
        text-align: right;
    }

    .current-price {
        font-size: 2.5em;
        font-weight: 800;
        color: #00bfa5;
    }

    /* Modern Green */
    .price-meta {
        color: #888;
        font-size: 0.95em;
        display: flex;
        gap: 20px;
        justify-content: flex-end;
    }

    /* Responsive Grid */
    .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        /* Left (Chart) 2/3, Right (Info) 1/3 */
        gap: 40px;
    }

    .description {
        color: #444;
        font-size: 1em;
        line-height: 1.7;
        max-height: 200px;
        overflow-y: auto;
    }

    .info-box h3,
    .news-box h3,
    .indicators-box h3,
    .recent-data-box h3 {
        color: var(--primary-color);
        border-left: 4px solid var(--secondary-color);
        padding-left: 10px;
        margin-bottom: 20px;
        font-size: 1.3em;
    }

    /* Metrics Grid & Tooltip */
    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .metric-item {
        position: relative;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        cursor: help;
        border: 1px solid #eee;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        border-color: #d0d7de;
    }

    .metric-item label {
        display: block;
        color: #888;
        font-size: 0.85em;
        margin-bottom: 5px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-item .value {
        font-size: 1.2em;
        font-weight: 700;
        color: var(--primary-color);
    }

    /* Tooltip CSS (Dark Blue Theme) */
    .tooltip-container .tooltip-text {
        visibility: hidden;
        width: 280px;
        background-color: #1e3a5f;
        color: #fff;
        text-align: left;
        border-radius: 8px;
        padding: 12px 16px;
        position: absolute;
        z-index: 9999;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
        font-size: 0.9em;
        line-height: 1.6;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    .tooltip-container .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: var(--primary-color) transparent transparent transparent;
    }

    .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* News List */
    .news-list {
        list-style: none;
        padding: 0;
    }

    .news-item {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
    }

    .news-item:last-child {
        border-bottom: none;
    }

    .news-title {
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
        display: block;
        margin-bottom: 8px;
        font-size: 1.05em;
        line-height: 1.4;
    }

    .news-title:hover {
        color: var(--secondary-color);
    }

    .news-meta {
        font-size: 0.8em;
        color: #999;
        margin-bottom: 8px;
        text-transform: uppercase;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
    }

    .news-summary {
        font-size: 0.95em;
        color: #555;
        margin: 0;
        line-height: 1.6;
    }

    .back-link {
        display: none;
    }

    /* Recent Data Table */
    .recent-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
        background: #fff;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid #eee;
    }

    .recent-table th {
        text-align: left;
        padding: 12px;
        background: #f8f9fa;
        color: #666;
        font-weight: 600;
        border-bottom: 1px solid #eee;
    }

    .recent-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        color: #444;
    }

    .recent-table tr:last-child td {
        border-bottom: none;
    }

    /* Modal Styles */
    .alert-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .alert-modal {
        background: white;
        width: 90%;
        max-width: 500px;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    .alert-modal-header {
        background: #fef2f2;
        padding: 20px;
        text-align: center;
        position: relative;
        border-bottom: 1px solid #fee2e2;
    }

    .alert-modal-icon {
        background: #fff;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        color: #ef4444;
    }

    .alert-modal-icon svg {
        width: 32px;
        height: 32px;
    }

    .alert-modal-header h3 {
        margin: 0;
        color: #991b1b;
        font-size: 1.5rem;
    }

    .alert-modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        color: #991b1b;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .alert-modal-close:hover {
        opacity: 1;
    }

    .alert-modal-body {
        padding: 25px;
    }

    .alert-modal-subtitle {
        color: #374151;
        font-weight: 500;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    .alert-items {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .alert-item {
        background: #fff1f2;
        padding: 12px 16px;
        border-radius: 8px;
        border-left: 4px solid #f87171;
        color: #7f1d1d;
        line-height: 1.5;
        font-size: 0.95rem;
    }

    .alert-modal-footer {
        padding: 20px;
        background: #f9fafb;
        border-top: 1px solid #f3f4f6;
        text-align: center;
    }

    .alert-disclaimer {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-bottom: 15px;
    }

    .alert-modal-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .alert-modal-btn:hover {
        background: #dc2626;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Collapsible Cards */
    .collapsible {
        transition: all 0.3s ease;
    }
    
    .card-header {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        cursor: pointer;
        user-select: none;
    }
    
    .collapse-icon {
        transition: transform 0.3s ease;
        font-size: 0.8em;
        color: #999;
    }
    
    .collapsible.collapsed .card-content {
        display: none;
    }
    
    .collapsible.collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
    
    /* Alert Icon Button in Header */
    .alert-icon-btn {
        background: none;
        border: none;
        color: #f59e0b;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        animation: pulse 2s infinite;
    }
    
    .alert-icon-btn:hover {
        background-color: #fef3c7;
        transform: scale(1.1);
    }
    
    .alert-icon {
        width: 24px;
        height: 24px;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
        100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {

        .main-grid {
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .detail-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .price-card {
            text-align: left;
        }

        .current-price {
            font-size: 2em;
        }

        .price-meta {
            justify-content: flex-start;
        }

        .recent-table {
            font-size: 0.8em;
        }
    }
</style>
{% endblock %}