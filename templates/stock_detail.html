{% extends 'base.html' %}

{% block title %}{{ stock.ticker }} - 詳細資訊{% endblock %}

{% block content %}
<!-- Breadcrumb Debug -->
<div class="breadcrumb">
    <a href="{% url 'dashboard' %}">儀表板</a> <span class="separator">/</span> <span class="current">
        {{ stock.ticker }}</span>
</div>

<div class="stock-detail-container">
    <!-- Top Section: Header & Price Card -->
    <div class="detail-header">
        <div class="stock-title">
            <h2>{{ stock.short_name|default:stock.name }} <span class="ticker-badge">{{ stock.ticker }}</span>
                {% if stock.alert_message %}
                <button onclick="openAlertModal()" class="alert-icon-btn" title="財務警示">
                    <svg class="alert-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                </button>
                {% endif %}
            </h2>
            <div class="market-badge">
                {{ stock.get_market_display }}
                {% if is_trading %}
                <span class="trading-status trading-now">● 交易中</span>
                {% else %}
                <span class="trading-status trading-closed">已收盤</span>
                {% endif %}
            </div>
        </div>

        <div class="price-card">
            {% if latest_price %}
            <div class="current-price" style="color: {% if stock.change > 0 %}#e11d48{% elif stock.change < 0 %}#059669{% else %}#333{% endif %};">
                {{ latest_price.close }}
                <span style="font-size: 1rem; margin-left: 10px;">
                    {% if stock.change > 0 %}▲{% elif stock.change < 0 %}▼{% endif %} {{ stock.change_percent|floatformat:2 }}%
                </span>
            </div>
            <div class="price-meta">
                <span class="date">資料日期: {{ latest_price.date }}</span>
                <span class="volume">成交量: {{ latest_price.volume }}</span>
            </div>
            {% else %}
            <div class="no-data">尚無股價資料</div>
            {% endif %}
        </div>
    </div>

    <!-- Main Section: Chart & Info -->
    <div class="main-grid">
        <!-- Left Column: Chart & Description -->
        <div class="chart-section">
            <div class="card-box chart-card">
                <h3>今日走勢 (Intraday)</h3>
                <div id="chart-intraday" style="width: 100%; height: 300px;"></div>
            </div>

            <div class="card-box chart-card" style="margin-top: 20px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <h3 style="margin:0;">歷史走勢 (Historical)</h3>
                </div>
                <div id="chart-historical" style="width: 100%; height: 500px;"></div>
            </div>

            <!-- 三大法人買賣超區塊 - 移至公司簡介上方 -->
            <div class="card-box collapsible institutional-box" style="margin-top: 20px;">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>三大法人買賣超</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="card-content">
                    <div id="chart-institutional" style="width: 100%; height: 350px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            載入中...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 月營收圖表（台股專用） -->
            <div class="card-box collapsible revenue-box" style="margin-top: 20px;" id="monthly-revenue-section">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>月營收 <span class="data-source-badge" id="revenue-source-badge"></span></h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="card-content">
                    <div id="chart-monthly-revenue" style="width: 100%; height: 320px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            載入中...
                        </div>
                    </div>
                </div>
            </div>

            <!-- PE/PB 走勢圖表 -->
            <div class="card-box collapsible perpbr-box" style="margin-top: 20px;" id="perpbr-section">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>PE/PB 走勢 <span class="data-source-badge" id="perpbr-source-badge"></span></h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="card-content">
                    <div id="chart-per-pbr" style="width: 100%; height: 320px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            載入中...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 融資融券圖表（台股專用） -->
            <div class="card-box collapsible margin-box" style="margin-top: 20px;" id="margin-trading-section">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>融資融券 <span class="data-source-badge" id="margin-source-badge"></span></h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="card-content">
                    <div id="chart-margin-trading" style="width: 100%; height: 320px;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            載入中...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 美股關鍵指標摘要（美股專用） -->
            <div class="card-box collapsible us-metrics-box" style="margin-top: 20px; display: none;" id="us-key-metrics-section">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>關鍵財務指標 <span class="data-source-badge" id="us-metrics-source-badge"></span></h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="card-content">
                    <div id="us-key-metrics-grid" class="us-metrics-grid">
                        載入中...
                    </div>
                    <div id="validation-warnings" class="validation-warnings" style="display: none;"></div>
                </div>
            </div>

            <div class="card-box collapsible info-box" style="margin-top: 20px;">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>公司簡介</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="card-content">
                    <div class="description" style="white-space: pre-wrap; line-height: 1.6; color: #444;">{{ stock.description|default:"暫無簡介" }}</div>
                </div>
            </div>

            <!-- 近期交易活動 - 可收放 -->
            <div class="card-box collapsible recent-data-box" style="margin-top: 30px;">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>近期交易明細</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="card-content">
                    <table class="recent-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>開盤</th>
                                <th>最高</th>
                                <th>最低</th>
                                <th>收盤</th>
                                <th>成交量</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in recent_prices %}
                            <tr>
                                <td>{{ price.date|date:"Y-m-d" }}</td>
                                <td>{{ price.open }}</td>
                                <td>{{ price.high }}</td>
                                <td>{{ price.low }}</td>
                                <td style="font-weight: bold; color: {% if price.close >= price.open %}#e11d48{% else %}#059669{% endif %};">{{ price.close }}</td>
                                <td>{{ price.volume }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999;">暫無近期數據</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Indicators & News -->
        <div class="info-section">
            <!-- Financial Indicators (Expert Dashboard) -->
            <div class="card-box indicators-box">
                <h3>財務診斷指標 (Expert View)</h3>
                
                <!-- 1. 獲利能力 Profitability -->
                <h4 style="margin: 15px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">獲利能力 (Profitability)</h4>
                <div class="metrics-grid">
                    <div class="metric-item tooltip-container">
                        <label>ROE (股東權益報酬率)</label>
                        <div class="value">
                            {% load stock_filters %}
                            {{ stock.roe|percentage }}
                        </div>
                        <span class="tooltip-text">巴菲特最看重的指標。衡量公司運用股東資金創造獲利的效率，長期 >15% 為佳。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>ROA (資產報酬率)</label>
                        <div class="value">{{ stock.roa|percentage }}</div>
                        <span class="tooltip-text">公司利用總資產賺錢的能力。ROA 與 ROE 差距過大可能代表高槓桿。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>毛利率 (Gross Margin)</label>
                        <div class="value">{{ stock.gross_margin|percentage }}</div>
                        <span class="tooltip-text">產品競爭力的護城河。越高代表產品越有定價權。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>營業利益率 (Op. Margin)</label>
                        <div class="value">{{ stock.operating_margin|percentage }}</div>
                        <span class="tooltip-text">本業賺錢的能力。扣除成本與營業費用後的獲利比率。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>淨利率 (Net Margin)</label>
                        <div class="value">{{ stock.profit_margin|percentage }}</div>
                        <span class="tooltip-text">最終落入口袋的錢。</span>
                    </div>
                </div>

                <!-- 2. 償債與結構 Solvency & Structure -->
                <h4 style="margin: 25px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">償債能力與結構 (Solvency)</h4>
                <div class="metrics-grid">
                    <div class="metric-item tooltip-container">
                        <label>負債權益比 (Debt/Equity)</label>
                        <div class="value">{{ stock.debt_to_equity|default:"-" }}%</div>
                        <span class="tooltip-text">衡量財務槓桿。數值過高 (如 >200) 代表債務壓力大，風險較高。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>速動比率 (Quick Ratio)</label>
                        <div class="value">{{ stock.quick_ratio|default:"-" }}</div>
                        <span class="tooltip-text">衡量短期償債能力。扣除存貨後的流動資產/流動負債，>1 為安全。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>貝塔值 (Beta)</label>
                        <div class="value">{{ stock.beta|default:"-" }}</div>
                        <span class="tooltip-text">波動風險係數。>1 代表波動比大盤大 (攻擊型)，<1 代表波動小 (防禦型)。</span>
                    </div>
                </div>

                <!-- 3. 估值與成長 Valuation -->
                <h4 style="margin: 25px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">估值與成長 (Valuation)</h4>
                <div class="metrics-grid">
                    <div class="metric-item tooltip-container">
                        <label>本益比 (P/E)</label>
                        <div class="value">{{ stock.pe_ratio|default:"-" }}</div>
                        <span class="tooltip-text">回本年限概念。成長股通常享有高本益比，價值股則較低。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>股價淨值比 (P/B)</label>
                        <div class="value">{{ stock.price_to_book|default:"-" }}</div>
                        <span class="tooltip-text">股價/每股淨值。通常 <1 代表股價低於清算價值，可能被低估。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>殖利率 (Yield)</label>
                        <div class="value">{{ stock.dividend_yield|default:"-" }}</div>
                        <span class="tooltip-text">現金股利回報率。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>市值 (Market Cap)</label>
                        <div class="value">{{ stock.market_cap|filesizeformat }}</div>
                        <span class="tooltip-text">公司總價值。</span>
                    </div>
                </div>

                <!-- 4. 現金流 Cash Flow -->
                <h4 style="margin: 25px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">現金流與財報 (Cash Flow)</h4>
                <div class="metrics-grid">
                    <div class="metric-item tooltip-container">
                        <label>自由現金流 (FCF)</label>
                        <div class="value" style="font-size: 0.9rem;">
                            {% if stock.free_cash_flow %}
                                {% load stock_filters %}{{ stock.free_cash_flow|format_revenue }}
                            {% else %}-{% endif %}
                        </div>
                        <span class="tooltip-text">公司真正可以自由運用的現金。正值代表公司有能力發股利或再投資。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>營收 (Revenue)</label>
                        <div class="value" style="font-size: 0.9rem;">
                            {% if stock.last_revenue %}
                            <a href="https://finance.yahoo.com/quote/{{ stock.ticker }}/financials" target="_blank" style="color: #2563eb; text-decoration: underline;">
                                {{ stock.last_revenue|format_revenue }}
                            </a>
                            {% else %}-{% endif %}
                        </div>
                        <span class="tooltip-text">最近一期總營收 (連結至 Yahoo Finance)。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>下次財報日</label>
                        <div class="value">
                            {% if stock.next_earnings_date %}
                                {{ stock.next_earnings_date|date:"Y-m-d" }}
                                {% now "Y-m-d" as today %}
                                {% if stock.next_earnings_date|date:"Y-m-d" < today %}
                                    <span style="background: #fecaca; color: #dc2626; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">已過期</span>
                                {% endif %}
                            {% else %}-{% endif %}
                        </div>
                        <span class="tooltip-text">預計公布財報日期。</span>
                    </div>
                </div>

                <!-- 5. 技術指標說明 Technical Indicators -->
                <h4 style="margin: 25px 0 10px; color: #4b5563; font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px;">技術指標說明 (Technical Indicators)</h4>
                <div style="background: #f8fafc; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong style="color: #1e3a5f; font-size: 0.95rem;">RSI 相對強弱指標</strong>
                        <div id="current-rsi-display" style="font-size: 1.2rem; font-weight: 700; padding: 6px 12px; border-radius: 6px; background: #e2e8f0; color: #64748b;">
                            載入中...
                        </div>
                    </div>
                    <p style="color: #64748b; font-size: 0.85rem; margin: 0 0 12px 0; line-height: 1.5;">
                        用來評估股價是否超買或超賣的動能指標。
                    </p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <div id="rsi-overbought-card" style="flex: 1; min-width: 120px; background: #fef3c7; padding: 10px; border-radius: 6px; border-left: 3px solid #f59e0b; opacity: 0.5;">
                            <strong style="color: #92400e; font-size: 0.8rem;">RSI > 70</strong>
                            <p style="color: #78350f; font-size: 0.75rem; margin: 3px 0 0 0;">超買區：股價可能過熱，有拉回風險</p>
                        </div>
                        <div id="rsi-oversold-card" style="flex: 1; min-width: 120px; background: #dbeafe; padding: 10px; border-radius: 6px; border-left: 3px solid #3b82f6; opacity: 0.5;">
                            <strong style="color: #1e40af; font-size: 0.8rem;">RSI < 30</strong>
                            <p style="color: #1e3a8a; font-size: 0.75rem; margin: 3px 0 0 0;">超賣區：股價可能過低，有反彈機會</p>
                        </div>
                    </div>
                    <p style="color: #94a3b8; font-size: 0.75rem; margin-top: 10px; text-align: right;">參數設定：RSI(14)</p>
                </div>
            </div>

            <!-- News Section - 支援分頁與情緒分析 -->
            <div class="card-box collapsible news-box" style="margin-top: 30px;">
                <div class="card-header" onclick="toggleCard(this)">
                    <h3>相關新聞 <span id="news-count" class="news-count-badge"></span></h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="card-content">
                    <div id="news-wrapper">
                        <div style="display: flex; align-items: center; justify-content: center; padding: 40px; color: #94a3b8;">
                            <svg class="animate-spin" style="width: 24px; height: 24px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            載入新聞中...
                        </div>
                    </div>
                    <!-- 分頁控制項 -->
                    <div id="news-pagination" class="news-pagination" style="display: none;">
                        <button onclick="prevNewsPage()" id="news-prev-btn" class="pagination-btn" disabled>
                            ← 上一頁
                        </button>
                        <span id="news-page-indicator" class="page-indicator">1/1</span>
                        <button onclick="nextNewsPage()" id="news-next-btn" class="pagination-btn">
                            下一頁 →
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div style="margin-top: 20px;">
        <a href="{% url 'dashboard' %}" class="back-link">&larr; 返回儀表板</a>
    </div>
</div>

<!-- 財務警示 Modal -->
{% if stock.alert_message %}
<div id="alertModal" class="alert-modal-backdrop" style="display: none;">
    <div class="alert-modal">
        <div class="alert-modal-header">
            <div class="alert-modal-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
            </div>
            <h3>財務警示分析</h3>
            <button onclick="closeAlertModal()" class="alert-modal-close">&times;</button>
        </div>
        <div class="alert-modal-body">
            <p class="alert-modal-subtitle">{{ stock.ticker }} 有以下需要關注的財務指標：</p>
            <div class="alert-items">
                {% for line in stock.alert_message.splitlines %}
                <div class="alert-item">
                    {{ line }}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="alert-modal-footer">
            <p class="alert-disclaimer">以上分析僅供參考，不構成投資建議。請自行評估風險。</p>
            <button onclick="closeAlertModal()" class="alert-modal-btn">了解</button>
        </div>
    </div>
</div>
{% endif %}

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ticker = "{{ stock.ticker }}";
        const api_url = "{% url 'stock_detail_api' stock.ticker %}";

        // DOM Elements
        const chartIntradayDom = document.getElementById('chart-intraday');
        const chartHistoricalDom = document.getElementById('chart-historical');
        const newsContainer = document.getElementById('news-wrapper'); // Updated selector
        const descContainer = document.querySelector('.description');

        // Show Loading State
        if (chartHistoricalDom) {
            const loadingChart = echarts.init(chartHistoricalDom);
            loadingChart.showLoading({ text: '數據載入中...', color: '#00bfa5', textColor: '#00bfa5' });
        }

        fetch(api_url)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // 1. Update Description
                if (descContainer) {
                    // Check if data is valid and not the generic API placeholder
                    if (data.description && data.description !== '暂无简介' && data.description.trim() !== '') {
                        descContainer.innerText = data.description;
                    } else {
                        descContainer.innerText = "暫無簡介";
                    }
                }

                // 2. Update News - 支援分頁與情緒 icon
                if (newsContainer) {
                    if (data.news && data.news.length > 0) {
                        // 儲存所有新聞用於分頁
                        window.allNewsItems = data.news;
                        window.newsCurrentPage = 1;
                        window.newsPerPage = 10;
                        
                        // 更新新聞數量 badge
                        const countBadge = document.getElementById('news-count');
                        if (countBadge) countBadge.textContent = data.news.length + ' 則';
                        
                        // 顯示分頁控制項
                        const pagination = document.getElementById('news-pagination');
                        if (pagination && data.news.length > window.newsPerPage) {
                            pagination.style.display = 'flex';
                        }
                        
                        // 渲染第一頁
                        renderNewsPage(1);
                    } else {
                        newsContainer.innerHTML = '<p class="no-news">暫無相關新聞</p>';
                    }
                }

                // 3. Render Intraday Chart
                // Dispose previous instance if any (though unlikely on fresh load)
                echarts.dispose(chartIntradayDom);
                if (data.intraday_data && data.intraday_data.length > 0) {
                    const myChart = echarts.init(chartIntradayDom);
                    const dates = data.intraday_data.map(item => item[0]);
                    const prices = data.intraday_data.map(item => item[1]);

                    const option = {
                        tooltip: { trigger: 'axis' },
                        grid: { left: '3%', right: '3%', top: '10%', bottom: '10%', containLabel: true },
                        xAxis: { type: 'category', data: dates, boundaryGap: false },
                        yAxis: { scale: true },
                        series: [{
                            name: '價格',
                            type: 'line',
                            data: prices,
                            smooth: true,
                            showSymbol: false,
                            lineStyle: { color: '#0066cc', width: 2 },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 102, 204, 0.3)' },
                                    { offset: 1, color: 'rgba(0, 102, 204, 0.05)' }
                                ])
                            }
                        }]
                    };
                    myChart.setOption(option);
                    window.addEventListener('resize', () => myChart.resize());
                } else {
                    chartIntradayDom.innerHTML = '<p class="no-data-text" style="text-align:center; padding-top:100px; color:#999;">暫無今日走勢資料</p>';
                }

                // 4. Render Historical Chart
                echarts.dispose(chartHistoricalDom);
                if (data.historical_data && data.historical_data.length > 0) {
                    const myChart = echarts.init(chartHistoricalDom);
                    const rawData = data.historical_data;
                    const dates = rawData.map(item => item[0]);
                    const ohlc = rawData.map(item => [item[1], item[2], item[3], item[4]]); // Open, Close, Low, High
                    const closes = rawData.map(item => item[2]);

                    // Calculations
                    function calculateMA(dayCount, data) {
                        var result = [];
                        for (var i = 0, len = data.length; i < len; i++) {
                            if (i < dayCount) {
                                result.push('-');
                                continue;
                            }
                            var sum = 0;
                            for (var j = 0; j < dayCount; j++) {
                                sum += data[i - j][2]; // Close
                            }
                            result.push((sum / dayCount).toFixed(2));
                        }
                        return result;
                    }

                    function calculateRSI(data, period = 14) {
                        let rsi = [];
                        for (let i = 0; i < data.length; i++) {
                            if (i < period) {
                                rsi.push('-');
                                continue;
                            }
                            let gain = 0, loss = 0;
                            for (let j = 0; j < period; j++) {
                                let change = data[i - j] - data[i - j - 1];
                                if (change > 0) gain += change;
                                if (change < 0) loss += Math.abs(change);
                            }
                            let rs = loss === 0 ? 100 : gain / loss;
                            let val = 100 - (100 / (1 + rs));
                            rsi.push(val.toFixed(2));
                        }
                        return rsi;
                    }

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' },
                            formatter: function (params) {
                                let res = params[0].name + '<br/>';
                                params.forEach(function (item) {
                                    // Custom formatting to clarify Price vs RSI
                                    let color = item.color;
                                    if (typeof color === 'object' && color.colorStops) color = color.colorStops[0].color; // Gradient handling

                                    if (item.seriesName === 'K線') {
                                        res += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${color};"></span>` +
                                            `開: ${parseFloat(item.data[1]).toFixed(2)} 收: ${parseFloat(item.data[2]).toFixed(2)} <br/>` +
                                            `&nbsp;&nbsp;&nbsp;&nbsp;低: ${parseFloat(item.data[3]).toFixed(2)} 高: ${parseFloat(item.data[4]).toFixed(2)}<br/>`;
                                    } else {
                                        let val = parseFloat(item.value);
                                        let displayVal = (item.seriesName === '成交量') ? val.toFixed(0) : val.toFixed(2);
                                        res += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>` +
                                            `${item.seriesName}: ${displayVal}<br/>`;
                                    }
                                });
                                return res;
                            }
                        },
                        legend: { data: ['K線', 'MA5', 'MA20', '成交量', 'RSI(14)'], top: 0 },
                        axisPointer: { link: { xAxisIndex: 'all' } },
                        grid: [
                            { left: '5%', right: '3%', top: '8%', height: '40%' },   // K-line
                            { left: '5%', right: '3%', top: '52%', height: '10%' },  // Volume
                            { left: '5%', right: '3%', top: '66%', height: '14%' }   // RSI
                        ],
                        xAxis: [
                            { type: 'category', data: dates, gridIndex: 0, axisLine: { onZero: false }, axisLabel: { show: false } },
                            { type: 'category', data: dates, gridIndex: 1, axisLabel: { show: false }, axisTick: { show: false } },
                            { type: 'category', data: dates, gridIndex: 2, axisLabel: { show: true, fontSize: 10, rotate: 45 }, axisTick: { show: true } }
                        ],
                        yAxis: [
                            { scale: true, gridIndex: 0, splitLine: { show: true } },
                            { scale: true, gridIndex: 1, splitLine: { show: false }, axisLabel: { show: false } },
                            { scale: true, gridIndex: 2, splitLine: { show: false }, min: 0, max: 100 }
                        ],
                        dataZoom: [
                            { type: 'inside', xAxisIndex: [0, 1, 2], start: 50, end: 100 },
                            { type: 'slider', xAxisIndex: [0, 1, 2], bottom: 0, start: 50, end: 100 }
                        ],
                        series: [
                            {
                                name: 'K線',
                                type: 'candlestick',
                                data: ohlc,
                                // Taiwan: Red=Up, Green=Down
                                itemStyle: { color: '#e11d48', color0: '#059669', borderColor: '#e11d48', borderColor0: '#059669' }
                            },
                            { name: 'MA5', type: 'line', data: calculateMA(5, rawData), smooth: true, lineStyle: { opacity: 0.5 } },
                            { name: 'MA20', type: 'line', data: calculateMA(20, rawData), smooth: true, lineStyle: { opacity: 0.5 } },
                            {
                                name: '成交量',
                                type: 'bar',
                                xAxisIndex: 1,
                                yAxisIndex: 1,
                                data: rawData.map((d, i) => ({
                                    value: d[5],  // Volume is at index 5: [date, O, C, L, H, Volume]
                                    itemStyle: { color: closes[i] >= (i > 0 ? closes[i-1] : closes[i]) ? '#e11d48' : '#059669' }
                                }))
                            },
                            {
                                name: 'RSI(14)',
                                type: 'line',
                                xAxisIndex: 2,
                                yAxisIndex: 2,
                                data: calculateRSI(closes, 14),
                                lineStyle: { color: '#8e44ad', width: 1.5 },
                                markLine: { symbol: 'none', data: [{ yAxis: 70, lineStyle: { color: '#f59e0b' } }, { yAxis: 30, lineStyle: { color: '#3b82f6' } }] }
                            }
                        ]
                    };
                    myChart.setOption(option);
                    window.addEventListener('resize', () => myChart.resize());
                    
                    // Update RSI Display in Sidebar
                    const rsiData = calculateRSI(closes, 14);
                    const latestRsi = rsiData.filter(v => v !== '-').pop();
                    const rsiDisplay = document.getElementById('current-rsi-display');
                    const overboughtCard = document.getElementById('rsi-overbought-card');
                    const oversoldCard = document.getElementById('rsi-oversold-card');
                    
                    if (latestRsi && rsiDisplay) {
                        const rsiValue = parseFloat(latestRsi);
                        rsiDisplay.textContent = rsiValue.toFixed(2);
                        
                        if (rsiValue > 70) {
                            // Overbought - Yellow/Orange
                            rsiDisplay.style.background = '#fef3c7';
                            rsiDisplay.style.color = '#92400e';
                            if (overboughtCard) overboughtCard.style.opacity = '1';
                        } else if (rsiValue < 30) {
                            // Oversold - Blue
                            rsiDisplay.style.background = '#dbeafe';
                            rsiDisplay.style.color = '#1e40af';
                            if (oversoldCard) oversoldCard.style.opacity = '1';
                        } else {
                            // Neutral - Green
                            rsiDisplay.style.background = '#d1fae5';
                            rsiDisplay.style.color = '#065f46';
                        }
                    } else if (rsiDisplay) {
                        rsiDisplay.textContent = 'N/A';
                    }
                } else {
                    chartHistoricalDom.innerHTML = '<p class="no-data-text" style="text-align:center; padding-top:150px; color:#999;">暫無歷史走勢資料</p>';
                }

                // 5. 三大法人買賣超圖表
                const institutionalDom = document.getElementById('chart-institutional');
                if (institutionalDom) {
                    // 容錯處理：檢查資料是否存在
                    if (data.institutional_investors === null) {
                        // 美股或不支援的市場
                        institutionalDom.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; 
                                        height: 100%; color: #94a3b8; flex-direction: column; gap: 12px;">
                                <svg style="width: 48px; height: 48px; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span style="font-size: 0.95rem;">此功能僅支援台股</span>
                            </div>`;
                    } else if (!data.institutional_investors || data.institutional_investors.length === 0) {
                        // 台股但無資料
                        institutionalDom.innerHTML = `
                            <p style="text-align: center; padding-top: 120px; color: #999;">
                                暫無三大法人買賣超資料
                            </p>`;
                    } else {
                        // 正常渲染圖表
                        const instData = data.institutional_investors;
                        const dates = instData.map(d => d.date);
                        
                        // 將股數轉換為張數（除以 1000）
                        const foreignNet = instData.map(d => Math.round(d.foreign_net / 1000));
                        const trustNet = instData.map(d => Math.round(d.trust_net / 1000));
                        const dealerNet = instData.map(d => Math.round(d.dealer_net / 1000));
                        
                        const instChart = echarts.init(institutionalDom);
                        const instOption = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' },
                                formatter: function(params) {
                                    let res = params[0].name + '<br/>';
                                    params.forEach(p => {
                                        const val = p.value;
                                        const color = val >= 0 ? '#e11d48' : '#059669';
                                        const sign = val >= 0 ? '+' : '';
                                        res += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${p.color};"></span>` +
                                               `${p.seriesName}: <span style="color:${color};font-weight:bold;">${sign}${val.toLocaleString()}</span> 張<br/>`;
                                    });
                                    return res;
                                }
                            },
                            legend: {
                                data: ['外資', '投信', '自營商'],
                                top: 0
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '15%',
                                top: '15%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'category',
                                data: dates,
                                axisLabel: { 
                                    rotate: 45, 
                                    fontSize: 10,
                                    interval: Math.floor(dates.length / 10) // 只顯示部分日期
                                }
                            },
                            yAxis: {
                                type: 'value',
                                name: '張數',
                                axisLabel: {
                                    formatter: function(val) {
                                        if (Math.abs(val) >= 10000) {
                                            return (val / 10000).toFixed(1) + '萬';
                                        }
                                        return val;
                                    }
                                }
                            },
                            dataZoom: [
                                { type: 'inside', start: 50, end: 100 },
                                { type: 'slider', bottom: 0, start: 50, end: 100, height: 20 }
                            ],
                            series: [
                                {
                                    name: '外資',
                                    type: 'bar',
                                    data: foreignNet,
                                    itemStyle: {
                                        color: function(params) {
                                            return params.value >= 0 ? '#ef4444' : '#22c55e';
                                        }
                                    }
                                },
                                {
                                    name: '投信',
                                    type: 'bar',
                                    data: trustNet,
                                    itemStyle: {
                                        color: function(params) {
                                            return params.value >= 0 ? '#f97316' : '#14b8a6';
                                        }
                                    }
                                },
                                {
                                    name: '自營商',
                                    type: 'bar',
                                    data: dealerNet,
                                    itemStyle: {
                                        color: function(params) {
                                            return params.value >= 0 ? '#a855f7' : '#06b6d4';
                                        }
                                    }
                                }
                            ]
                        };
                        instChart.setOption(instOption);
                        window.addEventListener('resize', () => instChart.resize());
                    }
                }

                // 6. 財務數據圖表渲染
                if (data.financial_data) {
                    const finData = data.financial_data;
                    const isTWStock = ticker.endsWith('.TW');
                    
                    // 更新資料來源標籤
                    function updateSourceBadge(elementId, sources) {
                        const badge = document.getElementById(elementId);
                        if (badge && sources && sources.length > 0) {
                            const sourceText = sources.join(', ');
                            badge.textContent = sourceText;
                            badge.style.background = '#e0f2fe';
                            badge.style.color = '#0369a1';
                            badge.style.padding = '2px 8px';
                            badge.style.borderRadius = '4px';
                            badge.style.fontSize = '0.75rem';
                            badge.style.marginLeft = '8px';
                        }
                    }
                    
                    // 6.1 月營收圖表（台股）
                    const revenueSection = document.getElementById('monthly-revenue-section');
                    const revenueDom = document.getElementById('chart-monthly-revenue');
                    
                    if (!isTWStock) {
                        if (revenueSection) revenueSection.style.display = 'none';
                    } else if (finData.monthly_revenue && finData.monthly_revenue.length > 0) {
                        updateSourceBadge('revenue-source-badge', ['FinMind']);
                        
                        const revData = finData.monthly_revenue;
                        const dates = revData.map(d => `${d.year}/${d.month}`);
                        const revenues = revData.map(d => d.revenue / 100000000); // 轉為億元
                        
                        const revenueChart = echarts.init(revenueDom);
                        const revenueOption = {
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    const p = params[0];
                                    return `${p.name}<br/>營收: ${(p.value).toFixed(2)} 億元`;
                                }
                            },
                            grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                            xAxis: {
                                type: 'category',
                                data: dates,
                                axisLabel: { fontSize: 10, rotate: 45 }
                            },
                            yAxis: {
                                type: 'value',
                                name: '億元',
                                axisLabel: { formatter: val => val.toFixed(0) }
                            },
                            series: [{
                                name: '月營收',
                                type: 'bar',
                                data: revenues,
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#667eea' },
                                        { offset: 1, color: '#764ba2' }
                                    ])
                                },
                                label: {
                                    show: revenues.length <= 12,
                                    position: 'top',
                                    formatter: p => p.value.toFixed(1),
                                    fontSize: 10
                                }
                            }]
                        };
                        revenueChart.setOption(revenueOption);
                        window.addEventListener('resize', () => revenueChart.resize());
                    } else {
                        revenueDom.innerHTML = '<p style="text-align:center; padding-top:100px; color:#999;">暫無月營收資料</p>';
                    }
                    
                    // 6.2 PE/PB 走勢圖表
                    const perpbrSection = document.getElementById('perpbr-section');
                    const perpbrDom = document.getElementById('chart-per-pbr');
                    
                    if (finData.per_pbr && finData.per_pbr.length > 0) {
                        const sources = finData.data_sources.filter(s => s.includes('perpbr'));
                        updateSourceBadge('perpbr-source-badge', sources.length > 0 ? sources : ['來源驗證中']);
                        
                        const ppData = finData.per_pbr;
                        const dates = ppData.map(d => d.date);
                        const peData = ppData.map(d => d.pe);
                        const pbData = ppData.map(d => d.pb);
                        
                        const perpbrChart = echarts.init(perpbrDom);
                        const perpbrOption = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: { type: 'cross' }
                            },
                            legend: { data: ['PE', 'PB'], top: 0 },
                            grid: { left: '3%', right: '10%', bottom: '15%', top: '15%', containLabel: true },
                            xAxis: {
                                type: 'category',
                                data: dates,
                                axisLabel: { fontSize: 10, rotate: 45, interval: Math.floor(dates.length / 10) }
                            },
                            yAxis: [
                                { type: 'value', name: 'PE', position: 'left' },
                                { type: 'value', name: 'PB', position: 'right' }
                            ],
                            dataZoom: [
                                { type: 'inside', start: 50, end: 100 },
                                { type: 'slider', bottom: 0, start: 50, end: 100, height: 20 }
                            ],
                            series: [
                                {
                                    name: 'PE',
                                    type: 'line',
                                    data: peData,
                                    smooth: true,
                                    lineStyle: { color: '#0ea5e9', width: 2 },
                                    areaStyle: {
                                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                            { offset: 0, color: 'rgba(14, 165, 233, 0.3)' },
                                            { offset: 1, color: 'rgba(14, 165, 233, 0.05)' }
                                        ])
                                    }
                                },
                                {
                                    name: 'PB',
                                    type: 'line',
                                    yAxisIndex: 1,
                                    data: pbData,
                                    smooth: true,
                                    lineStyle: { color: '#f59e0b', width: 2 }
                                }
                            ]
                        };
                        perpbrChart.setOption(perpbrOption);
                        window.addEventListener('resize', () => perpbrChart.resize());
                    } else if (!isTWStock && finData.key_metrics) {
                        // 美股：顯示簡單的 PE/PB 指標而非走勢圖
                        const km = finData.key_metrics;
                        perpbrDom.innerHTML = `
                            <div style="display: flex; justify-content: space-around; align-items: center; height: 100%; padding: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 2.5rem; font-weight: bold; color: #0ea5e9;">${km.pe_ratio ? km.pe_ratio.toFixed(2) : 'N/A'}</div>
                                    <div style="color: #64748b; margin-top: 8px;">PE Ratio</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2.5rem; font-weight: bold; color: #f59e0b;">${km.price_to_book ? km.price_to_book.toFixed(2) : 'N/A'}</div>
                                    <div style="color: #64748b; margin-top: 8px;">P/B Ratio</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2.5rem; font-weight: bold; color: #22c55e;">${km.peg_ratio ? km.peg_ratio.toFixed(2) : 'N/A'}</div>
                                    <div style="color: #64748b; margin-top: 8px;">PEG Ratio</div>
                                </div>
                            </div>`;
                        updateSourceBadge('perpbr-source-badge', ['yfinance']);
                    } else {
                        perpbrDom.innerHTML = '<p style="text-align:center; padding-top:100px; color:#999;">暫無 PE/PB 資料</p>';
                    }
                    
                    // 6.3 融資融券圖表（台股）
                    const marginSection = document.getElementById('margin-trading-section');
                    const marginDom = document.getElementById('chart-margin-trading');
                    
                    if (!isTWStock) {
                        if (marginSection) marginSection.style.display = 'none';
                    } else if (finData.margin_trading && finData.margin_trading.length > 0) {
                        updateSourceBadge('margin-source-badge', ['FinMind']);
                        
                        const mgData = finData.margin_trading;
                        const dates = mgData.map(d => d.date);
                        const marginBalance = mgData.map(d => d.margin_balance / 1000); // 轉為張
                        const shortBalance = mgData.map(d => d.short_balance / 1000);
                        
                        const marginChart = echarts.init(marginDom);
                        const marginOption = {
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    let res = params[0].name + '<br/>';
                                    params.forEach(p => {
                                        res += `${p.marker} ${p.seriesName}: ${Math.round(p.value).toLocaleString()} 張<br/>`;
                                    });
                                    return res;
                                }
                            },
                            legend: { data: ['融資餘額', '融券餘額'], top: 0 },
                            grid: { left: '3%', right: '4%', bottom: '15%', top: '15%', containLabel: true },
                            xAxis: {
                                type: 'category',
                                data: dates,
                                axisLabel: { fontSize: 10, rotate: 45, interval: Math.floor(dates.length / 10) }
                            },
                            yAxis: [
                                { type: 'value', name: '融資(張)', position: 'left' },
                                { type: 'value', name: '融券(張)', position: 'right' }
                            ],
                            dataZoom: [
                                { type: 'inside', start: 50, end: 100 },
                                { type: 'slider', bottom: 0, start: 50, end: 100, height: 20 }
                            ],
                            series: [
                                {
                                    name: '融資餘額',
                                    type: 'line',
                                    data: marginBalance,
                                    smooth: true,
                                    lineStyle: { color: '#ef4444', width: 2 },
                                    areaStyle: {
                                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                            { offset: 0, color: 'rgba(239, 68, 68, 0.3)' },
                                            { offset: 1, color: 'rgba(239, 68, 68, 0.05)' }
                                        ])
                                    }
                                },
                                {
                                    name: '融券餘額',
                                    type: 'line',
                                    yAxisIndex: 1,
                                    data: shortBalance,
                                    smooth: true,
                                    lineStyle: { color: '#22c55e', width: 2 }
                                }
                            ]
                        };
                        marginChart.setOption(marginOption);
                        window.addEventListener('resize', () => marginChart.resize());
                    } else {
                        marginDom.innerHTML = '<p style="text-align:center; padding-top:100px; color:#999;">暫無融資融券資料</p>';
                    }
                    
                    // 6.4 美股關鍵指標（美股）
                    const usMetricsSection = document.getElementById('us-key-metrics-section');
                    const usMetricsGrid = document.getElementById('us-key-metrics-grid');
                    
                    if (isTWStock) {
                        if (usMetricsSection) usMetricsSection.style.display = 'none';
                    } else if (finData.key_metrics && Object.keys(finData.key_metrics).length > 0) {
                        usMetricsSection.style.display = 'block';
                        updateSourceBadge('us-metrics-source-badge', finData.data_sources);
                        
                        const km = finData.key_metrics;
                        const formatPct = val => val ? (val * 100).toFixed(2) + '%' : 'N/A';
                        const formatNum = val => val ? val.toFixed(2) : 'N/A';
                        
                        usMetricsGrid.innerHTML = `
                            <div class="us-metric-card">
                                <div class="us-metric-label">ROE</div>
                                <div class="us-metric-value">${formatPct(km.roe)}</div>
                            </div>
                            <div class="us-metric-card">
                                <div class="us-metric-label">ROA</div>
                                <div class="us-metric-value">${formatPct(km.roa)}</div>
                            </div>
                            <div class="us-metric-card">
                                <div class="us-metric-label">毛利率</div>
                                <div class="us-metric-value">${formatPct(km.gross_margin)}</div>
                            </div>
                            <div class="us-metric-card">
                                <div class="us-metric-label">營業利益率</div>
                                <div class="us-metric-value">${formatPct(km.operating_margin)}</div>
                            </div>
                            <div class="us-metric-card">
                                <div class="us-metric-label">淨利率</div>
                                <div class="us-metric-value">${formatPct(km.profit_margin)}</div>
                            </div>
                            <div class="us-metric-card">
                                <div class="us-metric-label">負債權益比</div>
                                <div class="us-metric-value">${km.debt_to_equity ? km.debt_to_equity.toFixed(1) + '%' : 'N/A'}</div>
                            </div>
                            <div class="us-metric-card">
                                <div class="us-metric-label">營收成長率</div>
                                <div class="us-metric-value">${formatPct(km.revenue_growth)}</div>
                            </div>
                            <div class="us-metric-card">
                                <div class="us-metric-label">Beta</div>
                                <div class="us-metric-value">${formatNum(km.beta)}</div>
                            </div>
                        `;
                        
                        // 顯示驗證警告（如果有）
                        if (finData.validation_warnings && finData.validation_warnings.length > 0) {
                            const warningsDiv = document.getElementById('validation-warnings');
                            warningsDiv.style.display = 'block';
                            warningsDiv.innerHTML = `
                                <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 12px; margin-top: 16px;">
                                    <strong style="color: #92400e;">⚠️ 資料驗證警告</strong>
                                    <ul style="margin: 8px 0 0 20px; color: #78350f; font-size: 0.9rem;">
                                        ${finData.validation_warnings.map(w => `<li>${w}</li>`).join('')}
                                    </ul>
                                </div>`;
                        }
                    }
                }

            })
            .catch(err => {
                console.error('Fetch Error:', err);
                if (chartHistoricalDom) chartHistoricalDom.innerHTML = '<p style="text-align:center; padding-top:150px; color:red;">資料載入失敗，請稍後再試</p>';
            });

    }); // DOMContentLoaded 結束

    // === 新聞分頁相關函數 ===
    function renderNewsPage(page) {
        const newsContainer = document.getElementById('news-wrapper');
        if (!window.allNewsItems || !newsContainer) return;
        
        const start = (page - 1) * window.newsPerPage;
        const end = start + window.newsPerPage;
        const pageItems = window.allNewsItems.slice(start, end);
        
        const totalPages = Math.ceil(window.allNewsItems.length / window.newsPerPage);
        window.newsCurrentPage = page;
        
        // 渲染新聞項目含情緒 icon
        const newsItemsHtml = pageItems.map(item => {
            let sentimentHtml = '';
            if (item.sentiment === 'positive') {
                sentimentHtml = '<span class="sentiment-icon sentiment-positive">😊</span>';
            } else if (item.sentiment === 'negative') {
                sentimentHtml = '<span class="sentiment-icon sentiment-negative">😟</span>';
            } else {
                sentimentHtml = '<span class="sentiment-icon sentiment-neutral">•</span>';
            }
            
            return `
                <li class="news-item">
                    <a href="${item.link}" target="_blank" class="news-title">
                        ${sentimentHtml}${item.title}
                    </a>
                    <div class="news-meta">
                        <span>${item.publisher || 'Unknown'}</span>
                        <span>${item.date || ''}</span>
                    </div>
                </li>
            `;
        }).join('');
        
        newsContainer.innerHTML = `<ul class="news-list">${newsItemsHtml}</ul>`;
        
        // 更新分頁按鈕狀態
        const prevBtn = document.getElementById('news-prev-btn');
        const nextBtn = document.getElementById('news-next-btn');
        const indicator = document.getElementById('news-page-indicator');
        
        if (prevBtn) prevBtn.disabled = page <= 1;
        if (nextBtn) nextBtn.disabled = page >= totalPages;
        if (indicator) indicator.textContent = `${page}/${totalPages}`;
    }
    
    function prevNewsPage() {
        if (window.newsCurrentPage > 1) {
            renderNewsPage(window.newsCurrentPage - 1);
        }
    }
    
    function nextNewsPage() {
        const totalPages = Math.ceil(window.allNewsItems.length / window.newsPerPage);
        if (window.newsCurrentPage < totalPages) {
            renderNewsPage(window.newsCurrentPage + 1);
        }
    }

    // === 卡片收放函數 ===
    function toggleCard(headerElement) {
        const card = headerElement.closest('.collapsible');
        if (card) {
            card.classList.toggle('collapsed');
            // 儲存狀態到 localStorage
            const cardId = card.id || card.className;
            const isCollapsed = card.classList.contains('collapsed');
            localStorage.setItem('card-' + cardId.replace(/\s+/g, '-'), isCollapsed);
        }
    }
    
    // 載入卡片收放狀態
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.collapsible').forEach(card => {
            const cardId = card.id || card.className;
            const savedState = localStorage.getItem('card-' + cardId.replace(/\s+/g, '-'));
            if (savedState === 'true') {
                card.classList.add('collapsed');
            }
        });
    });

    // === 財務警示 Modal 函數 ===
    function openAlertModal() {
        const modal = document.getElementById('alertModal');
        if (modal) modal.style.display = 'flex';
    }
    
    function closeAlertModal() {
        const modal = document.getElementById('alertModal');
        if (modal) modal.style.display = 'none';
    }
    
    // 點擊背景關閉 Modal
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('alert-modal-backdrop')) {
            closeAlertModal();
        }
    });
    
    // ESC 鍵關閉 Modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeAlertModal();
    });

    // Real-time Price Update (Separate Endpoint)
    function updatePrice() {
        const currentPriceEl = document.querySelector('.current-price');
        // 加入一個簡單的閃爍效果
        if (currentPriceEl) {
             currentPriceEl.style.transition = 'color 0.5s';
        }

        fetch('{% url "get_latest_price" stock.ticker %}')
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                if (currentPriceEl) {
                    const oldPrice = parseFloat(currentPriceEl.textContent);
                    const newPrice = parseFloat(data.price);
                    
                    if (newPrice !== oldPrice) {
                        currentPriceEl.textContent = newPrice.toFixed(2);
                        // Flash color based on change
                        if (newPrice > oldPrice) {
                            currentPriceEl.style.color = '#e11d48'; // Red
                        } else if (newPrice < oldPrice) {
                            currentPriceEl.style.color = '#059669'; // Green
                        }
                    }
                }
            })
            .catch(e => console.log('Price update error:', e));
    }

    {% if is_trading %}
    setInterval(updatePrice, 10000);
    {% endif %}
</script>

<style>
    /* Breadcrumb */
    .breadcrumb {
        margin-bottom: 25px;
        font-size: 0.95em;
        color: #666;
        background: white;
        padding: 10px 15px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
    }

    .breadcrumb a {
        color: var(--secondary-color);
        font-weight: 500;
    }

    .stock-detail-container {
        padding: 30px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 25px;
        margin-bottom: 30px;
    }

    .stock-title h2 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 2em;
        color: var(--primary-color);
    }

    .ticker-badge {
        font-size: 0.5em;
        background: #e9ecef;
        padding: 4px 10px;
        border-radius: 20px;
        color: #495057;
        vertical-align: middle;
    }

    .market-badge {
        margin-top: 8px;
        color: #6c757d;
        font-weight: 600;
        font-size: 1.1em;
    }

    .price-card {
        text-align: right;
    }

    .current-price {
        font-size: 2.5em;
        font-weight: 800;
        color: #00bfa5;
    }

    /* Modern Green */
    .price-meta {
        color: #888;
        font-size: 0.95em;
        display: flex;
        gap: 20px;
        justify-content: flex-end;
    }

    /* Responsive Grid */
    .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        /* Left (Chart) 2/3, Right (Info) 1/3 */
        gap: 40px;
    }

    .description {
        color: #444;
        font-size: 1em;
        line-height: 1.7;
        max-height: 200px;
        overflow-y: auto;
    }

    .info-box h3,
    .news-box h3,
    .indicators-box h3,
    .recent-data-box h3 {
        color: var(--primary-color);
        border-left: 4px solid var(--secondary-color);
        padding-left: 10px;
        margin-bottom: 20px;
        font-size: 1.3em;
    }

    /* Metrics Grid & Tooltip */
    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .metric-item {
        position: relative;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        cursor: help;
        border: 1px solid #eee;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        border-color: #d0d7de;
    }

    .metric-item label {
        display: block;
        color: #888;
        font-size: 0.85em;
        margin-bottom: 5px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-item .value {
        font-size: 1.2em;
        font-weight: 700;
        color: var(--primary-color);
    }

    /* Tooltip CSS (Dark Blue Theme) */
    .tooltip-container .tooltip-text {
        visibility: hidden;
        width: 280px;
        background-color: #1e3a5f;
        color: #fff;
        text-align: left;
        border-radius: 8px;
        padding: 12px 16px;
        position: absolute;
        z-index: 9999;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
        font-size: 0.9em;
        line-height: 1.6;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    .tooltip-container .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -6px;
        border-width: 6px;
        border-style: solid;
        border-color: var(--primary-color) transparent transparent transparent;
    }

    .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* News List */
    .news-list {
        list-style: none;
        padding: 0;
    }

    .news-item {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
    }

    .news-item:last-child {
        border-bottom: none;
    }

    .news-title {
        font-weight: 700;
        color: var(--primary-color);
        text-decoration: none;
        display: block;
        margin-bottom: 8px;
        font-size: 1.05em;
        line-height: 1.4;
    }

    .news-title:hover {
        color: var(--secondary-color);
    }

    .news-meta {
        font-size: 0.8em;
        color: #999;
        margin-bottom: 8px;
        text-transform: uppercase;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
    }

    .news-summary {
        font-size: 0.95em;
        color: #555;
        margin: 0;
        line-height: 1.6;
    }

    .back-link {
        display: none;
    }

    /* Recent Data Table */
    .recent-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
        background: #fff;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid #eee;
    }

    .recent-table th {
        text-align: left;
        padding: 12px;
        background: #f8f9fa;
        color: #666;
        font-weight: 600;
        border-bottom: 1px solid #eee;
    }

    .recent-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        color: #444;
    }

    .recent-table tr:last-child td {
        border-bottom: none;
    }

    /* Modal Styles */
    .alert-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .alert-modal {
        background: white;
        width: 90%;
        max-width: 500px;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    .alert-modal-header {
        background: #fef2f2;
        padding: 20px;
        text-align: center;
        position: relative;
        border-bottom: 1px solid #fee2e2;
    }

    .alert-modal-icon {
        background: #fff;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        color: #ef4444;
    }

    .alert-modal-icon svg {
        width: 32px;
        height: 32px;
    }

    .alert-modal-header h3 {
        margin: 0;
        color: #991b1b;
        font-size: 1.5rem;
    }

    .alert-modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        color: #991b1b;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .alert-modal-close:hover {
        opacity: 1;
    }

    .alert-modal-body {
        padding: 25px;
    }

    .alert-modal-subtitle {
        color: #374151;
        font-weight: 500;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    .alert-items {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .alert-item {
        background: #fff1f2;
        padding: 12px 16px;
        border-radius: 8px;
        border-left: 4px solid #f87171;
        color: #7f1d1d;
        line-height: 1.5;
        font-size: 0.95rem;
    }

    .alert-modal-footer {
        padding: 20px;
        background: #f9fafb;
        border-top: 1px solid #f3f4f6;
        text-align: center;
    }

    .alert-disclaimer {
        font-size: 0.8rem;
        color: #9ca3af;
        margin-bottom: 15px;
    }

    .alert-modal-btn {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .alert-modal-btn:hover {
        background: #dc2626;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Collapsible Cards */
    .collapsible {
        transition: all 0.3s ease;
    }
    
    .card-header {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        cursor: pointer;
        user-select: none;
    }
    
    .collapse-icon {
        transition: transform 0.3s ease;
        font-size: 0.8em;
        color: #999;
    }
    
    .collapsible.collapsed .card-content {
        display: none;
    }
    
    .collapsible.collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
    
    /* Alert Icon Button in Header */
    .alert-icon-btn {
        background: none;
        border: none;
        color: #f59e0b;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        animation: pulse 2s infinite;
    }
    
    .alert-icon-btn:hover {
        background-color: #fef3c7;
        transform: scale(1.1);
    }
    
    .alert-icon {
        width: 24px;
        height: 24px;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
        100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {

        .main-grid {
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .detail-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .price-card {
            text-align: left;
        }

        .current-price {
            font-size: 2em;
        }

        .price-meta {
            justify-content: flex-start;
        }

        .recent-table {
            font-size: 0.8em;
        }
    }
</style>

<style>
    /* 美股關鍵指標 Grid */
    .us-metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
    }

    .us-metric-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        border: 1px solid #e2e8f0;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .us-metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .us-metric-label {
        font-size: 0.85rem;
        color: #64748b;
        margin-bottom: 8px;
    }

    .us-metric-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1e293b;
    }

    /* 資料來源標籤 */
    .data-source-badge {
        display: inline-block;
        background: #e0f2fe;
        color: #0369a1;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: 500;
    }

    /* 財務圖表區塊樣式 */
    .revenue-box h3,
    .perpbr-box h3,
    .margin-box h3,
    .us-metrics-box h3 {
        color: var(--primary-color);
        border-left: 4px solid #667eea;
        padding-left: 10px;
        margin-bottom: 0;
        font-size: 1.2em;
        display: flex;
        align-items: center;
    }

    /* Mobile Responsive for US Metrics */
    @media (max-width: 768px) {
        .us-metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}