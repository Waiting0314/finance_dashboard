{% extends 'base.html' %}

{% block title %}{{ stock.ticker }} - 詳細資訊{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="breadcrumb">
    <a href="{% url 'home' %}">首頁</a> &gt;
    <a href="{% url 'dashboard' %}">儀表板</a> &gt;
    <span>{{ stock.name }} ({{ stock.ticker }})</span>
</div>

<div class="stock-detail-container">
    <!-- Top Section: Header & Price Card -->
    <div class="detail-header">
        <div class="stock-title">
            <h2>{{ stock.name }} <span class="ticker-badge">{{ stock.ticker }}</span></h2>
            <div class="market-badge">{{ stock.get_market_display }}</div>
        </div>

        <div class="price-card">
            {% if latest_price %}
                <div class="current-price">{{ latest_price.close }}</div>
                <div class="price-meta">
                    <span class="date">資料日期: {{ latest_price.date }}</span>
                    <span class="volume">成交量: {{ latest_price.volume }}</span>
                </div>
            {% else %}
                <div class="no-data">尚無股價資料</div>
            {% endif %}
        </div>
    </div>

    <!-- Main Section: Chart & Info -->
    <div class="main-grid">
        <!-- Left Column: Chart & Description -->
        <div class="chart-section">
            <div id="main-chart" style="width: 100%; height: 400px;"></div>

             <div class="info-box" style="margin-top: 20px;">
                <h3>公司簡介</h3>
                <p class="description">{{ stock.description|default:"暫無簡介"|linebreaks }}</p>
            </div>
        </div>

        <!-- Right Column: Indicators & News -->
        <div class="info-section">
            <!-- Financial Indicators -->
            <div class="indicators-box">
                <h3>財務診斷指標</h3>
                <div class="metrics-grid">
                    <!-- Standard -->
                    <div class="metric-item tooltip-container">
                        <label>本益比 (P/E)</label>
                        <div class="value">{{ stock.pe_ratio|default:"-" }}</div>
                        <span class="tooltip-text">股價除以每股盈餘 (EPS)，用來評估股價是否昂貴。數值越低通常代表越便宜。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>每股盈餘 (EPS)</label>
                        <div class="value">{{ stock.eps|default:"-" }}</div>
                         <span class="tooltip-text">公司獲利能力的指標，代表每一股賺了多少錢。</span>
                    </div>

                    <!-- New Indicators -->
                    <div class="metric-item tooltip-container">
                        <label>貝塔值 (Beta)</label>
                        <div class="value">{{ stock.beta|default:"-" }}</div>
                        <span class="tooltip-text">衡量股票相對於大盤的波動風險。>1 代表波動比大盤大，<1 代表波動較小。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>市值 (Market Cap)</label>
                        <div class="value">{{ stock.market_cap|filesizeformat }}</div> <!-- Using filesizeformat as a rough formatter or we can filter it -->
                         <span class="tooltip-text">公司的總市場價值 (股價 x 總股數)，代表公司規模。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>殖利率 (Yield)</label>
                        <div class="value">{{ stock.dividend_yield|default:"-" }}</div>
                         <span class="tooltip-text">公司發放的現金股利佔股價的百分比，代表投資的現金回報率。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>ROE</label>
                        <div class="value">{{ stock.roe|default:"-" }}</div>
                         <span class="tooltip-text">股東權益報酬率，衡量公司運用股東資金創造獲利的效率。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>淨利率 (Margin)</label>
                        <div class="value">{{ stock.profit_margin|default:"-" }}</div>
                         <span class="tooltip-text">稅後淨利佔營收的比例，衡量公司的最終獲利能力。</span>
                    </div>
                    <div class="metric-item tooltip-container">
                        <label>股價淨值比 (P/B)</label>
                        <div class="value">{{ stock.price_to_book|default:"-" }}</div>
                         <span class="tooltip-text">股價除以每股淨值。通常 <1 代表股價可能被低估。</span>
                    </div>
                </div>
            </div>

            <!-- News Section -->
            <div class="news-box" style="margin-top: 30px;">
                <h3>相關新聞</h3>
                {% if news_items %}
                    <ul class="news-list">
                    {% for news in news_items %}
                        <li class="news-item">
                            <a href="{{ news.link }}" target="_blank" class="news-title">{{ news.title }}</a>
                            <div class="news-meta">{{ news.publisher }}</div>
                            <p class="news-summary">{{ news.summary|truncatechars:100 }}</p>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p class="no-news">暫無相關新聞</p>
                {% endif %}
            </div>

        </div>
    </div>

    <div style="margin-top: 20px;">
        <a href="{% url 'dashboard' %}" class="back-link">&larr; 返回儀表板</a>
    </div>
</div>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rawData = JSON.parse('{{ stock_data_json|safe }}');
        const chartDom = document.getElementById('main-chart');

        if (rawData && rawData.length > 0) {
            const myChart = echarts.init(chartDom);

            const dates = rawData.map(item => item.date);
            const ohlc = rawData.map(item => [item.open, item.close, item.low, item.high]);

            // Calculate MA
            function calculateMA(dayCount, data) {
                var result = [];
                for (var i = 0, len = data.length; i < len; i++) {
                    if (i < dayCount) {
                        result.push('-');
                        continue;
                    }
                    var sum = 0;
                    for (var j = 0; j < dayCount; j++) {
                        sum += data[i - j].close;
                    }
                    result.push((sum / dayCount).toFixed(2));
                }
                return result;
            }

            const option = {
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                legend: { data: ['K線', 'MA5', 'MA20'] },
                grid: { left: '10%', right: '10%', bottom: '15%' },
                xAxis: { type: 'category', data: dates },
                yAxis: { scale: true },
                dataZoom: [{ type: 'inside' }, { show: true }],
                series: [
                    {
                        name: 'K線',
                        type: 'candlestick',
                        data: ohlc
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: calculateMA(5, rawData),
                        smooth: true,
                        lineStyle: { opacity: 0.5 }
                    },
                    {
                        name: 'MA20',
                        type: 'line',
                        data: calculateMA(20, rawData),
                        smooth: true,
                        lineStyle: { opacity: 0.5 }
                    }
                ]
            };
            myChart.setOption(option);

            // Responsive resize
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        } else {
            chartDom.innerHTML = '<p style="text-align:center; padding-top: 150px; color:#999;">暫無歷史股價資料</p>';
        }
    });
</script>

<style>
    /* Breadcrumb */
    .breadcrumb { margin-bottom: 20px; font-size: 0.9em; color: #666; }
    .breadcrumb a { color: #007bff; text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }

    .stock-detail-container {
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }
    .stock-title h2 { margin: 0; display: flex; align-items: center; gap: 10px; }
    .ticker-badge { font-size: 0.6em; background: #e0e0e0; padding: 2px 8px; border-radius: 12px; color: #555; }
    .market-badge { margin-top: 5px; color: #777; font-weight: bold; }

    .price-card { text-align: right; }
    .current-price { font-size: 2em; font-weight: bold; color: #28a745; }
    .price-meta { color: #888; font-size: 0.9em; display: flex; gap: 15px; }

    /* Responsive Grid */
    .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr; /* Left (Chart) 2/3, Right (Info) 1/3 */
        gap: 30px;
    }

    .info-section {
        /* background: #fcfcfc; */
    }

    .description { color: #555; font-size: 0.95em; line-height: 1.6; max-height: 200px; overflow-y: auto; }

    /* Metrics Grid & Tooltip */
    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        /* margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 20px; */
    }
    .metric-item {
        position: relative; /* For tooltip */
        background: #f9f9f9;
        padding: 10px;
        border-radius: 5px;
        cursor: help; /* Indicate hover */
    }
    .metric-item label { display: block; color: #999; font-size: 0.8em; margin-bottom: 3px; }
    .metric-item .value { font-size: 1.1em; font-weight: 500; }

    /* Tooltip CSS */
    .tooltip-container .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%; /* Position above */
        left: 50%;
        margin-left: -100px; /* Center */
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8em;
        line-height: 1.4;
    }

    .tooltip-container .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }

    .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* News List */
    .news-list { list-style: none; padding: 0; }
    .news-item { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .news-item:last-child { border-bottom: none; }
    .news-title { font-weight: bold; color: #333; text-decoration: none; display: block; margin-bottom: 5px; }
    .news-title:hover { color: #007bff; }
    .news-meta { font-size: 0.8em; color: #888; margin-bottom: 5px; }
    .news-summary { font-size: 0.9em; color: #666; margin: 0; line-height: 1.4; }

    .back-link {
        display: inline-block;
        padding: 10px 20px;
        background: #f4f4f4;
        color: #333;
        text-decoration: none;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .back-link:hover { background: #e0e0e0; }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .main-grid { grid-template-columns: 1fr; }
        .detail-header { flex-direction: column; align-items: flex-start; gap: 15px; }
        .price-card { text-align: left; }
    }
</style>
{% endblock %}
